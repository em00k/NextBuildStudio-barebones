(()=>{var ae=Object.create;var k=Object.defineProperty;var se=Object.getOwnPropertyDescriptor;var le=Object.getOwnPropertyNames;var ce=Object.getPrototypeOf,ue=Object.prototype.hasOwnProperty;var R=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var de=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of le(e))!ue.call(r,i)&&i!==t&&k(r,i,{get:()=>e[i],enumerable:!(n=se(e,i))||n.enumerable});return r};var fe=(r,e,t)=>(t=r!=null?ae(ce(r)):{},de(e||!r||!r.__esModule?k(t,"default",{value:r,enumerable:!0}):t,r));var X=R(E=>{"use strict";E.__esModule=!0;E.GifWriter=E.IndexedColorImage=void 0;var pe=function(){function r(e,t,n){this.width=e.width,this.height=e.height,this.data=t,this.paletteData=n}return r}();E.IndexedColorImage=pe;var ve=function(){function r(){this.__out=[],this.__remNumBits=0,this.__remVal=0}return r.prototype.push=function(e,t){for(;t>0;)this.__remVal=(e<<this.__remNumBits&255)+this.__remVal,t+this.__remNumBits>=8?(this.__out.push(this.__remVal),t=t-(8-this.__remNumBits),e=e>>8-this.__remNumBits,this.__remVal=0,this.__remNumBits=0):(this.__remNumBits=t+this.__remNumBits,t=0)},r.prototype.flush=function(){this.push(0,8),this.__remNumBits=0,this.__remVal=0;var e=this.__out;return this.__out=[],e},r}();function _e(r,e){var t=new ve,n=1<<e,i=n+1,o=0,a=0,s=Object.create(null);function l(){o=i+1,a=e+1,s=Object.create(null)}l(),t.push(n,a);for(var d="",h=0,v=r.length;h<v;++h){var y=r[h],_=String.fromCharCode(y);_ in s||(s[_]=y);var w=d;d+=_,d in s||(t.push(s[w],a),o<=4095?(s[d]=o,o===1<<a&&a++,o++):(t.push(n,a),l(),s[_]=y),d=_)}return t.push(s[d],a),t.push(i,a),t.flush()}var ge=function(){function r(e){this.__os=e}return r.prototype.__writeInt2=function(e){this.__os.writeBytes([e&255,e>>8&255])},r.prototype.__writeDataSubBlocks=function(e){for(var t=this.__os,n=0,i;n<(i=Math.min(e.length,n+254));){var o=e.slice(n,i);t.writeByte(o.length),t.writeBytes(o),n=i}},r.prototype.__writeBlockTerminator=function(){this.__os.writeByte(0)},r.prototype.writeHeader=function(){var e=this.__os;e.writeBytes([71,73,70]),e.writeBytes([56,57,97])},r.prototype.writeTrailer=function(){this.__os.writeByte(59)},r.prototype.writeLogicalScreenInfo=function(e,t){var n,i,o;t||(t={});var a=(n=t.sizeOfColorTable)!==null&&n!==void 0?n:t.colorTableData?this.__calcSizeOfColorTable(t.colorTableData):7,s=(i=t.bgColorIndex)!==null&&i!==void 0?i:0,l=(o=t.pxAspectRatio)!==null&&o!==void 0?o:0;this.__writeLogicalScreenDescriptor(e,!!t.colorTableData,!!t.colorTableSortFlag,a,s,l),t.colorTableData&&this.__writeColorTable(t.colorTableData,a)},r.prototype.__calcSizeOfColorTable=function(e){for(var t=e.length/3,n=0,i=2;i<t;)n++,i=i<<1;return n},r.prototype.__writeLogicalScreenDescriptor=function(e,t,n,i,o,a){var s=this.__os;this.__writeInt2(e.width),this.__writeInt2(e.height),s.writeByte((t?128:0)|112|(n?8:0)|i),s.writeByte(o),s.writeByte(a)},r.prototype.writeTableBasedImage=function(e,t){t||(t={});var n=!0,i=this.__calcSizeOfColorTable(e.paletteData);this.__writeImageDescriptor(e,n,i,t),n&&this.__writeColorTable(e.paletteData,n?i:0),this.__writeImageData(e.data,i+1)},r.prototype.writeTableBasedImageWithGraphicControl=function(e,t){this.__writeGraphicControlExtension(t),this.writeTableBasedImage(e,t)},r.prototype.__writeImageDescriptor=function(e,t,n,i){var o,a,s=this.__os;s.writeByte(44);var l=(o=i?.leftPosition)!==null&&o!==void 0?o:0;this.__writeInt2(l);var d=(a=i?.topPosition)!==null&&a!==void 0?a:0;this.__writeInt2(d),this.__writeInt2(e.width),this.__writeInt2(e.height),s.writeByte((t?128:0)|0|0|0|n)},r.prototype.__writeImageData=function(e,t){var n=this.__os;t===1&&(t=2);var i=_e(e,t);n.writeByte(t),this.__writeDataSubBlocks(i),this.__writeBlockTerminator()},r.prototype.__writeColorTable=function(e,t){var n=this.__os;n.writeBytes(e);for(var i=3*Math.pow(2,t+1)-e.length,o=[];--i>=0;)o.push(0);n.writeBytes(o)},r.prototype.__writeGraphicControlExtension=function(e){var t,n;e||(e={});var i=this.__os,o=Math.round(((t=e.delayTimeInMS)!==null&&t!==void 0?t:0)/10),a=(n=e.disposalMethod)!==null&&n!==void 0?n:2,s,l;e.transparentColorIndex!==void 0&&e.transparentColorIndex>=0?(s=e.transparentColorIndex&255,l=1):(s=0,l=0),i.writeBytes([33,249,4]),i.writeByte(0|a<<2|0|l),this.__writeInt2(o),i.writeByte(s),i.writeByte(0)},r.prototype.writeLoopControlInfo=function(e){this.__os.writeBytes([33,255,11,78,69,84,83,67,65,80,69,50,46,48,3,1,e&255,e>>8&255,0])},r}();E.GifWriter=ge});var Y=R(N=>{"use strict";N.__esModule=!0;N.selectKthElem=void 0;function be(r,e){return Fe(r,0,r.length-1,e)}N.selectKthElem=be;function Fe(r,e,t,n){for(;;){var i=Math.floor((t+e)/2),o=Ce(r,e,t,i),a=o-e+1;if(n===a)return r[o];n<a?t=o-1:(n=n-a,e=o+1)}}function G(r,e,t){var n=r[e];r[e]=r[t],r[t]=n}function Ce(r,e,t,n){var i=r[n];G(r,n,t);for(var o=e,a=e;a<t;++a)r[a]<=i&&(G(r,o,a),o=o+1);return G(r,t,o),o}});var J=R(H=>{"use strict";H.__esModule=!0;H.MedianCutColorReducer=void 0;var ye=Y();function we(r,e){var t=0,n=!1,i=-1,o=-1,a=0;return e.forEach(function(s,l){var d=Math.floor(Math.pow(r.red-s.red,2)+Math.pow(r.green-s.green,2)+Math.pow(r.blue-s.blue,2));d==0?(n=!0,i=l,o=l):(t==0||d<t)&&(o=l,t=d)}),n?i:o}var Se=function(){function r(e){this.colors=e;var t=255,n=0,i=255,o=0,a=255,s=0;e.forEach(function(l){l.red<t&&(t=l.red),l.red>n&&(n=l.red),l.green<i&&(i=l.green),l.green>o&&(o=l.green),l.blue<a&&(a=l.blue),l.blue>s&&(s=l.blue)}),this.__minR=t,this.__maxR=n,this.__minG=i,this.__maxG=o,this.__minB=a,this.__maxB=s}return r.prototype.divide=function(){var e=this.largestEdge(),t=this.median(e),n=this.divideBy(e,t);return n},r.prototype.divideBy=function(e,t){var n=[],i=[];return this.colors.forEach(function(o){o[e]<t?n.push(o):i.push(o)}),n.length>0&&i.length>0?[new r(n),new r(i)]:[]},r.prototype.median=function(e){for(var t=[],n=this.colors,i=0,o=n.length;i<o;++i)t.push(n[i][e]);var a=ye.selectKthElem(t,Math.floor(t.length/2)+1);return a},r.prototype.largestEdge=function(){var e=(this.__maxR-this.__minR)*1,t=(this.__maxG-this.__minG)*.8,n=(this.__maxB-this.__minB)*.5;return t>=n?e>=t?"red":"green":e>=n?"red":"blue"},r.prototype.getNumberOfColors=function(){return this.colors.length},r.prototype.average=function(){var e=0,t=0,n=0;this.colors.forEach(function(o){e+=o.red,t+=o.green,n+=o.blue});var i=this.colors.length;return{red:Math.floor(e/i),green:Math.floor(t/i),blue:Math.floor(n/i)}},r}(),Be=function(){function r(e,t){this.__palette=[],this.__colorReductionMap={},this.__imageData=e,this.__maxPaletteSize=t||255}return r.prototype.process=function(){var e=this.__imageData,t=this.__maxPaletteSize,n=this.__extractColors(e),i=this.__medianCut(n,t),o=[],a=Object.create(null);i.forEach(function(l,d){o.push(l.average()),l.colors.forEach(function(h){for(var v=(h.red<<16|h.green<<8|h.blue<<0).toString(16);6-v.length;)v="0"+v;a[v]=d})}),this.__palette=o,this.__colorReductionMap=a;var s=[];return o.forEach(function(l){s.push(l.red),s.push(l.green),s.push(l.blue)}),s},r.prototype.map=function(e,t,n){for(var i=(e<<16|t<<8|n<<0).toString(16);6-i.length;)i="0"+i;return i in this.__colorReductionMap||(this.__colorReductionMap[i]=we({red:e,green:t,blue:n},this.__palette)),this.__colorReductionMap[i]},r.prototype.__extractColors=function(e){for(var t=e.width*e.height,n={},i=[],o=0;o<t;++o){for(var a=e.data[o*4+0],s=e.data[o*4+1],l=e.data[o*4+2],d=(a<<16|s<<8|l<<0).toString(16);6-d.length;)d="0"+d;n[d]||(n[d]=!0,i.push({red:a,green:s,blue:l}))}return i},r.prototype.__medianCut=function(e,t){var n=new Se(e),i=this.__divideUntil([n],t);return i},r.prototype.__divideUntil=function(e,t){for(;!(e.length>=t);){var n=this.__getLargestCube(e),i=n.divide();if(i.length<2)break;e=e.filter(function(o){return o!==n}).concat(i)}return e},r.prototype.__getLargestCube=function(e){var t,n=0;if(e.forEach(function(i){var o=i.getNumberOfColors();o>n&&(t=i,n=o)}),t===void 0)throw Error("`cubes` must have one or more elements.");return t},r}();H.MedianCutColorReducer=Be});var ee=R(S=>{"use strict";var Ee=S&&S.__createBinding||(Object.create?function(r,e,t,n){n===void 0&&(n=t),Object.defineProperty(r,n,{enumerable:!0,get:function(){return e[t]}})}:function(r,e,t,n){n===void 0&&(n=t),r[n]=e[t]}),Q=S&&S.__exportStar||function(r,e){for(var t in r)t!=="default"&&!e.hasOwnProperty(t)&&Ee(e,r,t)};S.__esModule=!0;Q(X(),S);Q(J(),S)});var z=acquireVsCodeApi();var g,x,p,m,A,$,O,T,U;function V(r){r||console.log("Error!")}function K(r){let e="";return[].slice.call(new Uint8Array(r)).forEach(n=>e+=String.fromCharCode(n)),window.btoa(e)}function u(r,e="",t=""){let n=document.createElement("DETAILS");n.classList.add("nomarker");let i=b(x,4),o=b(p,4),a=`
<summary>
	<div class="offset" title="Offset
Hex: ${i}">${x}</div>
	<div class="size" title="Size
Hex: ${o}">${p}</div>
	<div class="name">${r}</div>
	<div class="value">${e}</div>
	<div class="description">${t}</div>
</summary>
<div class="indent"></div>
`;n.innerHTML=a;let s=n.childNodes;A=s[3];let d=s[1].childNodes;return $=d[5],O=d[7],T=d[9],U=T.childNodes[3],m.appendChild(n),n}function xe(){m.lastChild.classList.remove("nomarker"),m=A}function he(){m=m.parentNode.parentNode}function B(r){xe();let e=x,t=p;p=0,r(),x=e,p=t,he()}function F(r){let e=m.lastChild;e.classList.remove("nomarker"),e.setAttribute("data-index",x.toString()),r&&e.addEventListener("toggle",function t(n){m=n.target;let i=m.getAttribute("data-index");x=parseInt(i),p=0,r(),this.removeEventListener("toggle",t)})}function Z(r,e="",t=""){let n=document.createElement("DETAILS");n.classList.add("nomarker");let i=`
<summary>
	<div class="offset"></div>
	<div class="size"></div>
	<div class="name">${r}</div>
	<div class="value">${e}</div>
	<div class="description">${t}</div>
</summary>
<div class="indent"></div>
`;n.innerHTML=i;let o=n.childNodes;A=o[3];let s=o[1].childNodes;return $=s[5],O=s[7],T=s[9],U=T.childNodes[3],m.appendChild(n),n}function j(r){O.title=r}function b(r,e){return r==null?"".padStart(e,"?"):r.toString(16).toUpperCase().padStart(e,"0")}function c(r){x+=p,p=r}function I(){let r=g[x],e=1;for(let t=1;t<p;t++)e*=256,r+=e*g[x+t];return r}function me(){let e=I().toString(16).toUpperCase();return e=e.padStart(p*2,"0"),e}function f(){return"0x"+me()}function C(r=0,e="Relative Offset"){let t="",n="";try{for(let i=0;i<p;i++){let o=i%16,a=x+i,s=r+i,l=g[a],d=b(l,2),h=l.toString(),v=b(s,4);if(o==0){t+=n,n="</div>";let _=i+1;for(;_<p&&l==g[x+_];_++);let w=_-_%16;if(w>i+16){_==p?i=p-1:i=w-1;let ne=b(r+i,4),ie="Offset (hex): "+b(a,4)+"-"+b(x+i,4)+`
Value (dec): `+h,oe="Relative offset (dec): "+s+"-"+(r+i)+`
Value (dec): `+h;t+="<div>",t+='<span class="indent mem_offset" title="'+ie+'">'+a+"-"+(x+i)+"</span>",t+='<span class="mem_offset" title="'+oe+'"> (0x'+v+"-0x"+ne+"): </span>",t+='<span title="Value (dec): '+h+'"> contain all '+d+"</span>";continue}let re=b(a,4);t+=`<div class="mem_dump">
					<div class="indent mem_offset" title = "Offset
Hex: ${re}">${a}</div>
				<div class="mem_rel_offset" title="${e}
Dec: ${s}">(0x${v})</div>
				`}let y="Offset (hex): "+b(a,4)+`
Offset (dec): `+a+`
Relative offset (hex): `+v+`
Relative offset (dec): `+s+`
Value (dec): `+h;t+='<div class="mem_byte" title="'+y+'">'+d+"&nbsp;</div>"}t+=n}catch{t+=n,t+='<div class="error indent">Error while parsing.</div>'}m.innerHTML+=t}function q(r){g=r,x=0,p=0,m=document.getElementById("div_root")}z.postMessage({command:"ready"});var L=fe(ee()),M=class r{constructor(){this.buffer=[]}writeByte(e){this.buffer.push(e)}writeBytes(e){Array.prototype.push.apply(this.buffer,e)}static createGifFromArray(e,t,n,i,o){let a=new L.IndexedColorImage({width:e,height:t},n,i),s=new r,l=new L.GifWriter(s);return l.writeHeader(),l.writeLogicalScreenInfo({width:a.width,height:a.height}),l.writeTableBasedImageWithGraphicControl(a,{transparentColorIndex:o}),l.writeTrailer(),s.buffer}};var D=class r{static{this.SCREEN_HEIGHT=192}static{this.SCREEN_WIDTH=256}static{this.SCREEN_SIZE=r.SCREEN_HEIGHT*r.SCREEN_WIDTH/8+r.SCREEN_HEIGHT/8*r.SCREEN_WIDTH/8}constructor(e,t){this.memory=e,this.ulaScreenAddressOffset=t}setUlaScreenAddress(e){this.ulaScreenAddressOffset=e}getUlaScreen(){let e=this.createPixels(),t=r.getZxPalette();return M.createGifFromArray(r.SCREEN_WIDTH,r.SCREEN_HEIGHT,e,t)}createPixels(){let e=this.memory,t=this.ulaScreenAddressOffset,n=t+r.SCREEN_HEIGHT*r.SCREEN_WIDTH/8,i=new Array(r.SCREEN_HEIGHT*r.SCREEN_WIDTH),o=0,a=0,s=0;for(let l=0;l<r.SCREEN_HEIGHT;l++){a=t+((l&7)<<8|(l&192)<<5|(l&56)<<2),s=n+((l&248)<<2);for(let d=0;d<r.SCREEN_WIDTH/8;d++){let h=e[a],v=e[s],y=128;for(;y;){let _=h&y,w=(v&64)>>>3;_?w|=v&7:w|=v>>>3&7,i[o]=w,y>>>=1,o++}a++,s++}}return i}static getZxPalette(){return[0,0,0,0,0,215,215,0,0,215,0,215,0,215,0,0,215,215,215,215,0,215,215,215,0,0,0,0,0,255,255,0,0,255,0,255,0,255,0,0,255,255,255,255,0,255,255,255]}};function P(r){return r>=6?r:[5,2,0,1,3,4][r]}function te(){switch(I()){case 0:return"BLACK";case 1:return"BLUE";case 2:return"RED";case 3:return"MAGENTA";case 4:return"GREEN";case 5:return"CYAN";case 6:return"YELLOW";case 7:return"WHITE"}return"UNKNOWN"}function W(){try{if(x+D.SCREEN_SIZE>g.length)throw Error();let e=new D(g,x).getUlaScreen(),t=K(e);m.innerHTML+='<img width="500px" style="image-rendering:pixelated" src="data:image/gif;base64,'+t+'">'}catch{m.innerHTML+='<div class="error">Error converting image.</div>'}}function Ie(){try{let r="<div><b>",e=g.length,t=!1;e==49179?r+="ZX48K SNA file.":e==131103||e==147487?(r+="ZX128K SNA file.",t=!0):r+='<span class="error">Wrong length.</span>',r+="</b></div>",r+="<div><b>Length:</b> "+e+"</div>";let n;if(t){r+="<div>Banks: 5, 2, ",n=g[49181]&7,r+=n.toString();for(let o=2;o<8;o++){let a=P(o);a!=n&&(r+=", "+a.toString())}r+="</div>"}if(r+="<br>",m.innerHTML=r,c(27),u("Header").open=!0,B(()=>{c(1),u("I",f(),"Interrupt Vector Register"),c(2),u("HL'",f(),"HL' Register"),c(2),u("DE'",f(),"DE' Register"),c(2),u("BC'",f(),"BC' Register"),c(2),u("AF'",f(),"AF' Register"),c(2),u("HL",f(),"HL Register"),c(2),u("DE",f(),"DE Register"),c(2),u("BC",f(),"BC Register"),c(2),u("IY",f(),"IY Register"),c(2),u("IX",f(),"IX Register"),c(1),u("Interrupt",f(),"Interrupt (bit 2 contains IFF2, 1=EI/0=DI)"),c(1),u("R",f(),"Memory Refresh Register"),c(2),u("AF",f(),"AF Register"),c(2);let i=I();if(u("SP",f(),"Stack Pointer"),!t){let o,a="PC is derived from the location SP points to.";if(i>=16384){let d=27+i-16384,h=g[d]+256*g[d+1];o=b(h,4)}else o="UNKNOWN",a+=" SP points to ROM. Can't decode.";let s=Z("PC",o,a);s.classList.add("indent"),s.classList.add("gray")}c(1),u("IM",f(),"Interrupt Mode (0=IM0/1=IM1/2=IM2)"),c(1),u("Border",te(),"Memory Refresh Register"),j(f())}),t){c(16384),u("Bank5: 0x4000-0x7FFF").open=!0,B(()=>{c(6912),u("Screen","","0x4000-0x5AFF").open=!0,B(()=>{c(6912),W(),u("Memory dump: 0x4000-0x5AFF"),F(()=>{c(6912),C(16384)})}),c(9472),u("0x5B00-0x7FFF"),F(()=>{c(9472),C(23296)})}),c(16384),u("Bank2: 0x8000-0xBFFF"),F(()=>{c(16384),C(32768)}),c(16384),u("Bank"+n.toString()+": 0xC000-0xFFFF"),F(()=>{c(16384),C(49152)}),c(2),u("PC",f(),"Program Counter"),c(1),u("Port 0x7FFD",f(),"Port 0x7ffd setting"),c(1),u("TRDOS ROM",f()," TR-DOS rom paged (1) or not (0)");for(let i=2;i<8;i++){let o=P(i);o!=n&&(c(16384),u("Bank"+o.toString()+":"),F(()=>{c(16384),C()}))}}else c(16384),u("0x4000-0x7FFF").open=!0,B(()=>{c(6912),u("Screen","","0x4000-0x5AFF").open=!0,B(()=>{c(6912),W(),u("Memory dump: 0x4000-0x5AFF"),F(()=>{c(6912),C(16384)})}),c(9472),u("0x5B00-0x7FFF"),F(()=>{c(9472),C(23296)})}),c(16384),u("0x8000-0xBFFF"),F(()=>{c(16384),C(32768)}),c(16384),u("0xC000-0xFFFF"),F(()=>{c(16384),C(49152)})}catch{let e=g.length-x;V(e>=0),e>0&&(c(e),u("Remaining","","Remaining data after parsing error."),F(()=>{c(e),C()}))}}window.addEventListener("message",r=>{let e=r.data;switch(e.command){case"setData":q(e.snaData),Ie();break}});})();
