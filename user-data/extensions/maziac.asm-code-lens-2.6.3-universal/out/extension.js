var Lo=Object.create;var be=Object.defineProperty;var Co=Object.getOwnPropertyDescriptor;var Ro=Object.getOwnPropertyNames;var Eo=Object.getPrototypeOf,Po=Object.prototype.hasOwnProperty;var Fo=(n,e)=>{for(var t in e)be(n,t,{get:e[t],enumerable:!0})},no=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Ro(e))!Po.call(n,o)&&o!==t&&be(n,o,{get:()=>e[o],enumerable:!(s=Co(e,o))||s.enumerable});return n};var P=(n,e,t)=>(t=n!=null?Lo(Eo(n)):{},no(e||!n||!n.__esModule?be(t,"default",{value:n,enumerable:!0}):t,n)),So=n=>no(be({},"__esModule",{value:!0}),n);var To={};Fo(To,{activate:()=>ko});module.exports=So(To);var R=P(require("vscode"));var Oe=P(require("vscode"));var so=P(require("vscode")),w=class{static Init(e){this.extension=e.extension}static getConfiguration(e){let s=this.extension.packageJSON.name;return so.workspace.getConfiguration(s,e)}};var f=class n{static{this.configs=new Map}static init(){let e=w.getConfiguration();n.globalToggleCommentPrefix=e.comments.toggleLineCommentPrefix,n.globalEnablePushPopMatching=e.enablePushPopMatching,n.globalEnableCodeLenses=!1,n.globalEnableHovering=!1,n.globalEnableCompletions=!1,n.globalEnableGotoDefinition=!1,n.globalEnableFindAllReferences=!1,n.globalEnableRenaming=!1,n.globalEnableOutlineView=!1;let t=Oe.workspace.workspaceFolders??[];for(let s of t){let o=new n,r=s.uri.fsPath;o.wsFolderPath=r;let i=w.getConfiguration(s);o.labelsWithColons=!0,o.labelsWithoutColons=!0;let l=(i.labels?.colon||"").toLowerCase();l.startsWith("without ")?o.labelsWithColons=!1:l.startsWith("with ")&&(o.labelsWithoutColons=!1);let a=i.labels?.excludes||"";o.labelsExcludes=a.toLowerCase().split(";"),o.excludeFiles=i.excludeFiles,o.enableCodeLenses=i.enableCodeLenses,o.enableHovering=i.enableHovering,o.enableCompletions=i.enableCompletions,o.enableGotoDefinition=i.enableGotoDefinition,o.enableFindAllReferences=i.enableFindAllReferences,o.enableRenaming=i.enableRenaming,o.enableOutlineView=i.enableOutlineView,o.completionsRequiredLength=i.completionsRequiredLength||0,o.completionsRequiredLength<1&&(o.completionsRequiredLength=1),o.workspaceSymbolsRequiredLength=i.workspaceSymbolsRequiredLength,o.workspaceSymbolsRequiredLength<1&&(o.workspaceSymbolsRequiredLength=1),o.enableWorkspaceSymbols=i.enableWorkspaceSymbols,o.enableFolding=i.enableFolding,n.configs.set(r,o),n.globalEnableCodeLenses||=i.enableCodeLenses,n.globalEnableHovering||=o.enableHovering,n.globalEnableCompletions||=o.enableCompletions,n.globalEnableGotoDefinition||=o.enableGotoDefinition,n.globalEnableFindAllReferences||=o.enableFindAllReferences,n.globalEnableRenaming||=o.enableRenaming,n.globalEnableOutlineView||=o.enableOutlineView,n.globalEnableWorkspaceSymbols||=o.enableWorkspaceSymbols}}static getConfigForDoc(e){if(!e)return;let t=Oe.workspace.getWorkspaceFolder(e.uri);if(t)return n.configs.get(t.uri.fsPath)}};var ae=class extends RegExp{constructor(e,t){super(t),this.find=e}exec(e){return e.indexOf(this.find)<0?null:super.exec(e)}},M=class extends RegExp{constructor(e,t){super(t),this.simpleRegex=e}exec(e){return this.simpleRegex.exec(e)?super.exec(e):null}};var m=class n{static regexLabelWithAndWithoutColon(){return/(^@?)([a-z_][\w.]*):?/i}static regexLabelWithColon(e){return e==="asm-list-file"?new ae(":",/(^[^#]*\s@?)([a-z_][\w.]*):/i):/(^@?)([a-z_][\w.]*):/i}static regexLabelWithoutColon(){return/^(@?)([a-z_][\w.]*)(?:\s|$)/i}static regexLabel(e,t){return t==="asm-list-file"?n.regexLabelWithColon(t):e.labelsWithColons&&e.labelsWithoutColons?n.regexLabelWithAndWithoutColon():e.labelsWithoutColons?n.regexLabelWithoutColon():n.regexLabelWithColon(t)}static regexInclude(){return new M(/INCLUDE/i,/\s*INCLUDE\s+"(.*)"/i)}static regexModuleStruct(){return new M(/(MODULE|STRUCT)/i,/^.*\s(MODULE|STRUCT)\s+([\w.]+)/i)}static regexEndModuleStruct(){return new M(/(ENDMODULE|ENDS)/i,/^.*\s(ENDMODULE|ENDS)\b/i)}static calcStartIndex(e){let t=e.index;for(let s=1;s<e.length;s++)if(e[s]){let o=e[s].length;t+=o}return t}static regexLabelColonForWord(e,t){return t=="asm-list-file"?new M(new RegExp(e,"i"),new RegExp("^(.*?\\s)([[a-zA-Z_\\.][\\w\\.]*)?\\b"+e+":")):new RegExp("^()([a-zA-Z_\\.][\\w\\.]*)?\\b"+e+":")}static regexLabelWithoutColonForWord(e){return new RegExp("^()([a-zA-Z_\\.][\\w\\.]*)?\\b"+e+"\\b(?![:\\.])")}static regexesLabelForWord(e,t,s){let o=[];if(t.labelsWithColons){let r=n.regexLabelColonForWord(e,s);o.push(r)}if(t.labelsWithoutColons&&s=="asm-collection"){let r=n.regexLabelWithoutColonForWord(e);o.push(r)}return o}static regexModuleForWord(e){return new M(/module/i,new RegExp("^(.*\\s(module|MODULE)\\s+)"+e+"\\b"))}static regexMacroForWord(e){return new M(/macro/i,new RegExp("^(.*\\s(macro|MACRO)\\s+)"+e+"\\b"))}static regexAnyReferenceForWord(e){return new ae(e,new RegExp("^([^#]*)\\b"+e+"\\b"))}static regexPrepareFuzzy(e){return e.replace(/(.)/g,"\\w*$1")}};var N=P(require("vscode"));var ce,Ve,io,xe;function ro(n){xe=new Set([";","//"]),n&&xe.add(n);let e=Array.from(xe),t=`("|'|/\\*|`+e.join("|")+")";ce=new RegExp(t,"g");let s="^(.*?)("+e.join("|")+")(.*)";Ve=new RegExp(s,"i");let o="("+e.join("|")+")";io=new RegExp(o,"i")}function oe(n){let e=!1,t=n.length;for(let s=0;s<t;s++){let o=n[s];if(e){let i=o.indexOf("*/");if(i>=0)o=" ".repeat(i+2)+o.substring(i+2),e=!1;else{n[s]="";continue}}ce.lastIndex=0;let r;for(;r=ce.exec(o);){let i=r.index,l=r[1];if(l==='"'||l==="'"){let a=o.indexOf(l,i+1);if(a>=0)o=o.substring(0,i)+" ".repeat(a-i+1)+o.substring(a+1),ce.lastIndex=a+1;else{o=o.substring(0,i);break}}else if(l==="/*"){let a=o.indexOf("*/",i+2);if(a>=0)o=o.substring(0,i)+" ".repeat(a-i+2)+o.substring(a+2),ce.lastIndex=a+2;else{o=o.substring(0,i),e=!0;break}}else if(xe.has(l)){o=o.substring(0,i);break}}n[s]=o}}function lo(n,e){if(n.length==0||e<0||e>=n.length)return[];let t=[],s=n[e];(io.test(s)||s.toLowerCase().indexOf("equ")>=0)&&t.unshift(s);let r=e-1;if(r>=0){let i=n[r],l=i.indexOf("*/");l<0&&(l=Number.MAX_SAFE_INTEGER);let a=Ve.exec(i),c=Number.MAX_SAFE_INTEGER;if(a&&(c=a[1].length),l!=c)if(c<l)for(t.unshift(a[3]),r--;r>=0;){let d=n[r],u=Ve.exec(d);if(!u)break;t.unshift(u[3]),r--}else{let d=i.substring(0,l);for(d=d.trimEnd(),d&&t.unshift(d),r--;r>=0;){let u=n[r],p=u.indexOf("/*");if(p>=0){let g=u.substring(p+2);g=g.trimEnd(),g&&t.unshift(g);break}t.unshift(u),r--}}}return t}function Ge(n){let e=m.regexModuleStruct(),t=m.regexEndModuleStruct(),s=[],o=n.length,r=[];for(let i=0;i<o;i++){let l=n[i],a=e.exec(l),c=t.exec(l);if(a)s.push(a[2]);else if(c)s.pop();else continue;let d=s.join(".");r.push({row:i,label:d})}return r}function K(n,e,t=/[\w.]/){let s=n.length,o;for(o=e;o<s;o++){let c=n.charAt(o);if(!t.exec(c))break}let r;for(r=e-1;r>=0;r--){let c=n.charAt(r);if(!/[\w.]/.exec(c))break}r++;let i=n.substring(r,o),l=n.substring(0,r),a=!1;return r>0&&(a=n.charAt(r-1)==="@"),{label:i,preString:l,atLabel:a}}function je(n,e,t,s){let o;for(;t>s;t--){let r=e[t];if(o=n.exec(r),o){let i=o[2],l=o[1]==="@";return{label:i,atLabel:l}}}return{label:"_",atLabel:!1}}function yo(n,e){return!n||n.length==0?e:n+"."+e}function Ue(n,e,t,s,o=/[\w.]/){let r=e.lines,i=r[t],{label:l,preString:a,atLabel:c}=K(i,s,o);if(l.includes("exi")){console.log("getLabelAndModuleLabelFromFileInfo: "+l);let b=K(i,s,o);console.log(b)}let d,u=-1;if(!c)for(let b of e.modStructInfos){if(b.row>=t)break;d=b.label,u=b.row}if(l.startsWith(".")){let b=je(n,r,t,u);l=b.label+l,b.atLabel&&(d=void 0)}let p=yo(d,l),g=a.length+l.length;return(a.length===0||i[g]===":")&&(l=p),{label:l,moduleLabel:p}}var ao=P(require("path")),co=require("assert"),go=P(require("vscode"));var de=class{constructor(e,t){this.cacheTime=e,this.func=t,this.nextTime=Date.now()}getData(){let e=Date.now();return e>=this.nextTime&&(this.cachedData=this.func(),this.nextTime=e+this.cacheTime),this.cachedData}};var he=class n{static{this.asmCollectionCache=new de(1e4,()=>n._getGlobalIncludeForLanguageId("asm-collection"))}static{this.asmFileListCache=new de(1e4,()=>n._getGlobalIncludeForLanguageId("asm-list-file"))}static getGlobalIncludeForLanguageId(e){if(e=="asm-collection")return n.asmCollectionCache.getData();if(e=="asm-list-file")return n.asmFileListCache.getData();(0,co.strict)(!1,'languageId = "'+e+'" unknown.')}static _getGlobalIncludeForLanguageId(e){let s=w.extension.packageJSON.contributes.languages,o=[];for(let a of s)if(a.id==e){o.push(...a.extensions.map(c=>c.substring(1)));break}let r=go.workspace.getConfiguration("files.associations"),i=Object.entries(r);for(let[a,c]of i)if(typeof c=="string"){let d=ao.extname(a).substring(1);if(c==e)o.push(d);else{let u=o.indexOf(d);u>=0&&o.splice(u,1)}}return"**/*.{"+o.join(",")+"}"}};var He=class extends N.Location{constructor(e,t,s){super(e,t),this.fileMatch=s;let{label:o}=K(s.lineContents,s.start);this.symbol=o}};function Mo(n,e){let t=new Map;return n.forEach(o=>t.set(e(o),o)),Array.from(t.values())}async function po(n){return new Promise((e,t)=>{let s=N.Uri.file(n);N.workspace.openTextDocument(s).then(o=>e(o),o=>t(o))})}async function uo(n){try{let t=(await po(n)).getText().split(`
`);return oe(t),t}catch(e){return console.log(e),[]}}async function X(n,e,t,s){let o=new Map;try{let i=he.getGlobalIncludeForLanguageId(t),a=(await N.workspace.findFiles(i,s)).filter(c=>c.fsPath.startsWith(e));for(let c of a){let d=c.fsPath,u=await po(d),p=qe(u,n);for(let g of p)g.filePath=d;o.set(d,p)}}catch(i){console.log("Error: ",i)}let r=[];for(let[i,l]of o)for(let a of l){let c=a.line,d=a.start,u=a.end,p=new N.Position(c,d),g=new N.Position(c,u),b=new He(N.Uri.file(i),new N.Range(p,g),a);r.push(b)}return r}async function q(n,e,t,s){let o=[];for(let r of n){let i=await X(r,e,t,s);o.push(...i)}return n.length>0&&(o=Mo(o,r=>{let i=r.fileMatch;return i.filePath+":"+i.line+":"+i.start})),o}function qe(n,e){let t=[],s=n.getText().split(`
`);oe(s);let o=s.length;for(let r=0;r<o;r++){let i=s[r];e.lastIndex=0;do{let l=e.exec(i);if(!l)break;let a=m.calcStartIndex(l),c=l.index+l[0].length;t.push({filePath:void 0,line:r,start:a,end:c,lineContents:i,match:l})}while(e.global)}return t}function mo(n){let e,t,s=n.indexOf(".");s<0?(e="",t=n):(e=n.substring(0,s+1),t=n.substring(s+1));let o=m.regexPrepareFuzzy(t)+"\\w*",r=e.replace(/(\.)/g,"\\.");return r+=o,new RegExp(r,"i")}async function A(n,e,t,s,o=!0,r=!0,i=/[\w.]/){let l=await uo(t),a=Ge(l),d=Ue(n,{lines:l,modStructInfos:a},s.line,s.character,i),u,p;r||(u=mo(d.label),p=mo(d.moduleLabel));let g=[...e],b=new Map,h=g.length;for(;h--;){let x=g[h],k=x.uri.fsPath,C=x.range.start,L=b[k];if(!L){let T=await uo(k),F=Ge(T);L={lines:T,modStructInfos:F},b[k]=L}if(o&&C.line===s.line&&k===t){g.splice(h,1);continue}let E=Ue(n,L,C.line,C.character,i);if(x.label=E.label,x.moduleLabel=E.moduleLabel,r){if(E.label===d.label||E.moduleLabel===d.moduleLabel||E.moduleLabel===d.label||E.label===d.moduleLabel)continue}else if(u.exec(E.label)||p.exec(E.moduleLabel)||u.exec(E.moduleLabel)||p.exec(E.label))continue;g.splice(h,1)}return g}function fo(n,e){let t=m.regexModuleStruct(),s=m.regexEndModuleStruct(),o=[];for(let i=0;i<e;i++){let l=n[i],a=t.exec(l);if(a){o.push(a[2]);continue}s.exec(l)&&o.pop()}return o.join(".")}var we=class{async provideReferences(e,t,s,o){let r=f.getConfigForDoc(e);if(!r?.enableFindAllReferences)return;let i=e.getWordRangeAtPosition(t);if(!i)return;let l=e.getText(i),a=m.regexAnyReferenceForWord(l),c=e.languageId,d=await X(a,r.wsFolderPath,c,r.excludeFiles),u=m.regexLabel(r,c);return await A(u,d,e.fileName,t,!1,!0,/\w/)}};var ve=class{static regexStructForWord(e){return new M(/struct/i,new RegExp("^(.*?\\s+(struct|STRUCT)\\s+)"+e+"\\b"))}};var O=P(require("vscode"));var Le=class{async provideDefinition(e,t,s){let o=f.getConfigForDoc(e);if(!o){await O.window.showWarningMessage("Document is in no workspace folder.");return}if(!o.enableGotoDefinition){await O.window.showWarningMessage("Goto definitions are disabled for this workspace folder.");return}let r=e.lineAt(t.line).text,i=m.regexInclude().exec(r);return i?this.getInclude(o,i[1]):this.search(o,e,t)}async getInclude(e,t){let s=new O.RelativePattern(e.wsFolderPath,"**/"+t),o=await O.workspace.findFiles(s,null),r=[],i=new O.Position(0,0),l=new O.Range(i,i);for(let a of o){let c=new O.Location(a,l);r.push(c)}return r}async search(e,t,s){let o=t.getWordRangeAtPosition(s);if(!o)return;let r=t.getText(o);if(e.labelsExcludes.includes(r))return;let i=t.languageId,l=m.regexesLabelForWord(r,e,i),a=m.regexModuleForWord(r);l.push(a);let c=m.regexMacroForWord(r);l.push(c);let d=ve.regexStructForWord(r);l.push(d);let u=await q(l,e.wsFolderPath,t.languageId,e.excludeFiles),p=m.regexLabel(e,i);return await A(p,u,t.fileName,s,!1,!0,/\w/)}};var Q=P(require("vscode"));var Ce=class{async provideHover(e,t,s){let o=f.getConfigForDoc(e);if(!o?.enableHovering)return;let r=/\w/,i=e.lineAt(t.line).text,{label:l}=K(i,t.character,r);if(l.startsWith("."))return new Q.Hover("");let a=e.languageId,c=e.getWordRangeAtPosition(t);if(!c)return;let d=e.getText(c),u=m.regexesLabelForWord(d,o,a),p=m.regexModuleForWord(d);u.push(p);let g=m.regexMacroForWord(d);u.push(g);let b=await q(u,o.wsFolderPath,a,o.excludeFiles),h=m.regexLabel(o,a),v=await A(h,b,e.fileName,t,!1,!0,r),x=new Array;for(let C of v){let L=C.moduleLabel;if(o.labelsExcludes.includes(L))continue;let E=C.range.start.line,T=C.uri.fsPath,y=(await Q.workspace.openTextDocument(T)).getText().split(`
`),U=lo(y,E);U.length>0&&(x.length>0&&x.push(new Q.MarkdownString("============")),x.push(...U.map(J=>new Q.MarkdownString(J))))}return x.length==0?void 0:new Q.Hover(x)}};var te=P(require("vscode"));var bo=require("fs"),$=P(require("vscode"));var j=class{static Init(e){this.context=e}static Get(e){return this.context.globalState.get(e)}static Set(e,t){(async()=>await this.context.globalState.update(e,t))()}};var Re=class{static{this.enableDonationInfo=!1}static{this.evaluateDonateTime=void 0}static{this.donateEndTime=void 0}static async showInfoMessage(e,...t){return""}static openDonateWebView(){}static now(){return Date.now()}static getPreviousVersion(){return""}static getCurrentVersion(){return""}static getDonationTime(){}static setDonationTime(e){}static getDonatedPref(){return!1}static checkVersion(){let e=this.getPreviousVersion();this.getCurrentVersion()!=e&&this.setDonationTime(void 0),this.donatedPreferencesChanged()}static donatedPreferencesChanged(){let e=this.getDonatedPref();this.evaluateDonateTime=e?void 0:this.now()}static checkDonateInfo(){this.enableDonationInfo&&this.evaluateDonateTime!=null&&this.now()>=this.evaluateDonateTime&&(this.evaluateDonateTime=this.now()+this.daysInMs(1),this.donateEndTime==null&&(this.donateEndTime=this.getDonationTime(),this.donateEndTime==null&&(this.donateEndTime=this.now()+this.daysInMs(14),this.setDonationTime(this.donateEndTime))),this.now()<this.donateEndTime?(async()=>(await this.showInfoMessage("If you use 'ASM Code Lens' regularly please support the project. Every little donation helps keeping the project running.","Yes, please. I want to show my support","Not now"))?.toLowerCase().startsWith("yes")&&this.openDonateWebView())():this.evaluateDonateTime=void 0)}static daysInMs(e){return e*24*60*60*1e3}};var Io=require("path"),Z=class extends Re{static{this.VERSION_ID="version"}static{this.DONATE_TIME_ID="donateTimeId"}static async showInfoMessage(e,...t){return $.window.showInformationMessage(e,...t)}static getPreviousVersion(){return j.Get(this.VERSION_ID)}static getCurrentVersion(){return w.extension.packageJSON.version}static getDonationTime(){return j.Get(this.DONATE_TIME_ID)}static setDonationTime(e){j.Set(this.DONATE_TIME_ID,e)}static getDonatedPref(){return!!w.getConfiguration().get("donated")}static openDonateWebView(){let e=$.window.createWebviewPanel("","",{preserveFocus:!0,viewColumn:$.ViewColumn.Nine});e.title="Donate...";let t=w.extension.extensionPath,s=Io.join(t,"html/donate.html"),o=(0,bo.readFileSync)(s).toString(),r=$.Uri.file(t),i=e.webview.asWebviewUri(r).toString();o=o.replace("${vscodeResPath}",i),e.webview.options={enableScripts:!0},e.webview.onDidReceiveMessage(l=>{switch(l.command){case"showExtension":(async()=>await $.commands.executeCommand("workbench.extensions.search",w.extension.packageJSON.publisher))();break}}),e.webview.html=o}};var _e=class extends te.CodeLens{constructor(e,t,s,o){super(s),this.config=e,this.document=t,this.symbol=o}},Ee=class{async provideCodeLenses(e,t){Z.checkDonateInfo();let s=f.getConfigForDoc(e);if(!s?.enableCodeLenses)return;let o=e.languageId,r=[],i=m.regexLabel(s,o),l=qe(e,i);for(let a of l){let c=a.line,d=a.match[1]?a.match[1].length:0,u=a.end,g=e.lineAt(c).text.substring(d,u);g.endsWith(":")&&(u--,g=g.substring(0,g.length-1));let b=g.trim();if(!s.labelsExcludes.includes(b.toLowerCase())){let h=new te.Position(c,d),v=new te.Position(c,u),x=new te.Range(h,v),k=new _e(s,e,x,b);r.push(k)}}return r}async resolveCodeLens(e,t){let s=e.symbol,o=m.regexAnyReferenceForWord(s),r=e.document,i=e.range.start,l=e.config,a=r.languageId,c=await X(o,l.wsFolderPath,a,l.excludeFiles),d=m.regexLabel(l,a),u=await A(d,c,r.fileName,i,!0,!0),p=u.length,g=p+" reference";return p!=1&&(g+="s"),e.command={title:g,command:"editor.action.showReferences",arguments:[r.uri,i,u]},e}};var ge=P(require("vscode"));var Pe=class{static regexAnyReferenceForWordGlobal(e){return new M(new RegExp("\\b"+e+"\\b"),new RegExp("(.*?)\\b"+e+"\\b","g"))}};var Fe=class{async provideRenameEdits(e,t,s,o){let r=new ge.WorkspaceEdit,i=f.getConfigForDoc(e);if(!i)return await ge.window.showWarningMessage("Document is in no workspace folder."),r;if(!i.enableRenaming)return await ge.window.showWarningMessage("Renaming is disabled for this workspace folder."),r;let l=e.getWordRangeAtPosition(t);if(!l)return r;let a=e.getText(l),c=Pe.regexAnyReferenceForWordGlobal(a),d=e.languageId,u=await X(c,i.wsFolderPath,d,i.excludeFiles),p=m.regexLabel(i,d),g=await A(p,u,e.fileName,t,!1,!0,/\w/);for(let b of g)r.replace(b.uri,b.range,s);return r}};var I=P(require("vscode"));var ee=class{static regexModuleLabel(){return/\b(module\s+([a-z_][\w.]*)|endmodule.*)/i}static regexStructLabel(){return/\b(struct\s+([a-z_][\w.]*)|ends.*)/i}static regexConst(){return/\b(equ)\s+(.*)/i}static regexData(){return/\b(d[bcdghmsw]|def[bdghmsw])\b\s*(.*)/i}static regexMacro(e){if(e!=="asm-list-file")return/\b(macro)\s+(.*)/i}};var Se=class{provideDocumentSymbols(e,t){let s=f.getConfigForDoc(e);if(!s?.enableOutlineView)return;let o=e.languageId,r=[],i=m.regexLabel(s,o),l=ee.regexModuleLabel(),a=ee.regexStructLabel(),c=["include",...s.labelsExcludes],d=ee.regexConst(),u=ee.regexData(),p=ee.regexMacro(o),g,b=new Array,h,v=new Array,x=e.getText().split(`
`);oe(x);let k=x.length;for(let C=0;C<k;C++){let L=x[C],E=i.exec(L);if(E){let F=E[0].trimEnd(),S=E[1]+E[2];if(!c.includes(S)){let y=new I.Range(C,0,C,Number.MAX_SAFE_INTEGER),U=y;if(g=new I.DocumentSymbol(S,"",I.SymbolKind.Function,y,U),b.push(g),S.startsWith("."))h?.push(g);else if(S.startsWith("@"))r.push(g);else{let Y=v.length;Y>0?v[Y-1].children.push(g):r.push(g),h=g.children}let J=F.length;L=L.substring(J),L+=" "}}if(p){let F=p.exec(L);if(F){let S=F[2];S===""&&(S=" ");let y=new I.Range(C,0,C,Number.MAX_SAFE_INTEGER),U=new I.DocumentSymbol(S,"macro",I.SymbolKind.Interface,y,y);r.push(U);continue}}let T=l.exec(L);if(T||(T=a.exec(L)),T){let F=T[1].toLowerCase(),S=T[2];if(S){let y=new I.Range(C,0,C,Number.MAX_SAFE_INTEGER),U=F.startsWith("module")?I.SymbolKind.Module:I.SymbolKind.Struct,J=new I.DocumentSymbol(S,"",U,y,y),Y=v.length;Y>0?v[Y-1].children.push(J):r.push(J),v.push(J)}(F=="endmodule"||F=="ends")&&(v.pop(),h=void 0),g=void 0,b.length=0;continue}if(L=L.trim(),g&&L){let F,S=d.exec(L);if(S?F=I.SymbolKind.Constant:(S=u.exec(L),S&&(F=I.SymbolKind.Field)),F!=null)for(let y of b)y.kind=F,y.detail=S[1]+" "+S[2].trimEnd();g=void 0,b.length=0;continue}}return r}};var D=P(require("vscode"));var _=class{static regexesEveryLabelForWord(e,t,s){let o=[];if(t.labelsWithColons){let r=this.regexEveryLabelColonForWord(e,s);o.push(r)}if(t.labelsWithoutColons&&s=="asm-collection"){let r=this.regexEveryLabelWithoutColonForWord(e);o.push(r)}return o}static regexEveryLabelWithoutColonForWord(e){return new RegExp("^(([^0-9 ][\\w\\.]*)?)\\b"+e+"[\\w\\.]*\\b(?![:\\w\\.])","i")}static regexEveryLabelColonForWord(e,t){return t==="asm-list-file"?new RegExp("^(.*)\\b"+e+"[\\w\\.]*:","i"):new RegExp("(^@?[\\w\\.]*|^.*\\s@?[\\w\\.]*)\\b"+e+"[\\w\\.]*:","i")}static regexEveryModuleForWord(e,t){return t=="asm-list-file"?new RegExp("^(.*?\\s+(MODULE)\\s+)"+e+"[\\w\\.]*","i"):new RegExp("^(\\s+(MODULE)\\s+)"+e+"[\\w\\.]*","i")}static regexEveryMacroForWord(e,t){return t=="asm-list-file"?new RegExp("^(.*?\\s+(MACRO)\\s+)"+e+"[\\w\\._]*","i"):new RegExp("^(\\s+(MACRO)\\s+)"+e+"[\\w\\._]*","i")}};var Do=["a","b","c","d","e","h","l","af","bc","de","hl","ix","iy","sp","ixl","ixh","iyl","iyh","adc","add","and","bit","call","ccf","cp","cpd","cpdr","cpi","cpir","cpl","daa","dec","di","ei","djnz","ex","exx","halt","im","inc","in","ind","indr","ini","inir","jp","jr","ld","ldd","lddr","ldi","ldir","neg","nop","or","otdr","otir","out","outd","outi","pop","push","res","ret","reti","retn","rl","rla","rlc","rlca","rld","rr","rra","rrc","rrca","rrd","rst","sbc","scf","set","sla","slia","sll","swap","sra","srl","sub","xor","ldix","ldws","ldirx","lddx","lddrx","ldpirx","outinb","mul","swapnib","mirror","nextreg","pixeldn","pixelad","setae","test","bsla","bsra","bsrl","bsrf","brlc","sli","macro","endm","module","endmodule","struct","ends","dup","edup","if","ifn","ifdef","ifndef","ifused","ifnused","else","endif","include","incbin","abyte","abytec","abytez","align","assert","binary","block","defb","defd","defg","defh","defl","defm","defs","defw","dephase","disp","phase","unphase","d24","db","dc","dd","dg","dh","hex","dm","ds","dw","dz","display","byte","word","dword","emptytap","emptytrd","encoding","equ","export","end","endlua","endt","ent","includelua","inchob","inctrd","insert","lua","labelslist","org","outend","output","memorymap","mmu","page","rept","endr","savebin","savedev","savehob","savesna","savetrd","savetap","basic","code","numbers","chars","headless","savenex","core","cfg","cfg3","bar","palette","default","mem","bmp","screen","l2","l2_320","l2_640","scr","shc","shr","tile","cooper","bank","auto","shellexec","size","slot","tapend","tapout","textarea","define","undefine","defarray","defarray+","device","ZXSPECTRUM48","ZXSPECTRUM128","ZXSPECTRUM256","ZXSPECTRUM512","ZXSPECTRUM1024","ZXSPECTRUM2048","ZXSPECTRUM4096","ZXSPECTRUM8192","ZXSPECTRUMNEXT","NONE","ramtop","open","close","setbp","setbreakpoint","bplist","unreal","zesarux","opt","cspectmap","fpos","_sjasmplus","_version","_release","_errors","_warnings"],ye=class{async provideCompletionItems(e,t,s){let o=f.getConfigForDoc(e);if(!o?.enableCompletions)return;let r=o.completionsRequiredLength,i=e.lineAt(t).text,l=K(i,t.character),a=l.label.length;if(l.label.startsWith(".")&&a--,a<r)return new D.CompletionList([new D.CompletionItem(" ")],!1);let c=e.getText().split(`
`),d=t.line,u=fo(c,d),p=c[d],g=K(p,t.character),b=g.preString.length,h=b+g.label.length,v=new D.Range(new D.Position(d,b),new D.Position(d,h)),x=e.languageId,k=m.regexLabel(o,x),C;g.label.startsWith(".")&&(C=je(k,c,d,-1).label);let L=e.getWordRangeAtPosition(t);if(!L)return;let E=e.getText(L),T=m.regexPrepareFuzzy(E),F=_.regexesEveryLabelForWord(T,o,x),S=_.regexEveryModuleForWord(T,x);F.push(S);let y=_.regexEveryMacroForWord(T,x);F.push(y);let U=await q(F,o.wsFolderPath,x,o.excludeFiles),J=await A(k,U,e.fileName,t,!0,!1),Y=new Map;for(let fe of J){let H=fe.moduleLabel;if(o.labelsExcludes.includes(H))continue;let W=new D.CompletionItem(H,D.CompletionItemKind.Function);if(W.filterText=H,W.range=v,C){W.filterText=g.label;let G=u.length;G>0&&G++,G+=C.length;let se=H.substring(G);W.insertText=se,W.label=se,W.filterText=se}else if(H.startsWith(u+".")){let G=u.length+1,se=H.substring(G);W.insertText=se,W.label="["+H.substring(0,G)+"] "+se}Y.set(W.label,W)}let me=Array.from(Y.values()),pe;if(g.label.lastIndexOf(".")<0){let fe=g.label[0]===g.label[0].toUpperCase(),H=0;pe=Do.map(W=>{fe&&(W=W.toUpperCase());let G=new D.CompletionItem(W,D.CompletionItemKind.Function);return G.sortText=H.toString(),H++,G.range=v,G}),pe.push(...me)}else pe=me;return new D.CompletionList(pe,!1)}};var xo=P(require("path")),De=P(require("vscode"));var Me=class{static regexLabelEquOrMacro(){return new M(/(equ|macro)/i,/^.*[a-z_][\w.]*[:\s]\s*(equ|macro)/i)}};var ne=De.window.createOutputChannel("ASM Code Lens"),Ie=class{static async findLabelsWithNoReference(e,t){let s=m.regexLabel(e,t),o=await q([s],e.wsFolderPath,t,e.excludeFiles);await this.findLabels(o,e,t)}static async findLabels(e,t,s){let o=xo.basename(t.wsFolderPath),r=s=="asm-list-file"?"list":"asm";ne.appendLine("Unreferenced labels for "+r+" files, "+o+":"),ne.show(!0);try{let i=e.length,l=0,a=Me.regexLabelEquOrMacro(),c=m.regexLabel(t,s);for(let d of e){let u=d.fileMatch;if(a.lastIndex=u.match[1].length,a.exec(u.lineContents)){i--,i==0&&ne.appendLine("Done. "+l+" unreferenced label"+(l>1?"s":"")+".");continue}let g=u.match[2],b=g.replace(/\./,"\\."),h=new De.Position(u.line,u.start),v=u.filePath,x=m.regexAnyReferenceForWord(b),k=await X(x,t.wsFolderPath,s,t.excludeFiles);if((await A(c,k,v,h,!0,!0)).length==0&&(l++,ne.appendLine(g+", "+v+":"+(h.line+1))),i--,i==0){let E=l+" unreferenced label";ne.appendLine("Done. "+E+(l>1?"s":"")+".")}}}catch(i){console.log("Error: ",i)}e.length==0&&ne.appendLine("None."),ne.appendLine("")}};var ho=P(require("vscode")),wo=P(require("path")),vo=require("fs");var ue=class{resolveWebviewView(e,t,s){this.webview=e.webview,this.webview.options={enableScripts:!0},this.webview.onDidReceiveMessage(o=>{switch(o.command){case"donateClicked":Z.openDonateWebView();break}}),this.setMainHtml()}setMainHtml(){if(!this.webview)return;let e=w.extension.extensionPath,t=wo.join(e,"html","hexcalc.html"),s=(0,vo.readFileSync)(t).toString(),o=ho.Uri.file(e),r=this.webview.asWebviewUri(o).toString();s=s.replace(/\${vscodeResPath}/g,r);let i=w.getConfiguration(),l=i.get("hexCalculator.hexPrefix");s=s.replace("//${init}",`
let hexPrefix = "${l}";`),i.get("donated")||(s=s.replace("<!--${donate}-->",`
		<button class="button-donate" style="float:right" onclick="donateClicked()">Donate...<div style="float:right;font-size:50%">ASM Code Lens</div></button>`)),this.webview.html=s}};var re=P(require("vscode")),ze=P(require("path")),Je=require("fs");var ke=class{static isNewVersion(e,t){try{if(!e)return!1;let s=e.split(".");if(s.length<2)return!1;if(!t)return!0;let o=t.split(".");if(o.length<2)return!0;let r=parseInt(s[0]);if(isNaN(r))return!1;let i=parseInt(s[1]);if(isNaN(i))return!1;let l=parseInt(o[0]);if(isNaN(l))return!0;let a=parseInt(o[1]);return!!(isNaN(a)||r>l||i>a)}catch{return!1}}};var ie=class{static updateVersion(){let e="version",t=j.Get(e),s=w.extension.packageJSON.version;return s!==t&&j.Set(e,s),t?ke.isNewVersion(s,t):!1}constructor(){this.vscodePanel=re.window.createWebviewPanel("","",{preserveFocus:!0,viewColumn:re.ViewColumn.Nine}),this.vscodePanel.title="Whats New",this.setHtml()}setHtml(){if(!this.vscodePanel.webview)return;let e=w.extension.extensionPath,t=ze.join(e,"html/whatsnew.html"),s=(0,Je.readFileSync)(t).toString(),o=re.Uri.file(e),r=this.vscodePanel.webview.asWebviewUri(o).toString();s=s.replace("${vscodeResPath}",r),s=s.replace(/\${extensionName}/g,w.extension.packageJSON.id);let i=w.extension.packageJSON.version.split("."),l=i.shift()||"",a=i.shift();a&&(l+="."+a),s=s.replace(/\${extensionMainVersion}/g,l),s=s.replace(/\${extensionDisplayName}/g,w.extension.packageJSON.displayName),s=s.replace(/\${repositoryUrl}/g,w.extension.packageJSON.repository.url),s=s.replace(/\${repositoryIssues}/g,w.extension.packageJSON.bugs.url),s=s.replace(/\${repositoryHomepage}/g,w.extension.packageJSON.repository.url);let c=ze.join(e,"html/whatsnew_changelog.html"),d=(0,Je.readFileSync)(c).toString();s=s.replace("${changeLog}",d),this.vscodePanel.webview.html=s}};var le=P(require("vscode"));var Te=class{provideWorkspaceSymbols(e,t){return new Promise(s=>{(async()=>{let o=[],r=le.workspace.workspaceFolders;if(r){let i=e.length;for(let l of r){if(t.isCancellationRequested){s(void 0);return}let a=f.configs.get(l.uri.fsPath);if(!a?.enableWorkspaceSymbols)continue;let c=a.workspaceSymbolsRequiredLength;if(i<c)continue;let d=await this.getWsSymbols(a,e);o.push(...d)}}s(o)})()})}async getWsSymbols(e,t){let s="asm-collection",o=m.regexPrepareFuzzy(t),r=_.regexesEveryLabelForWord(o,e,s),i=_.regexEveryModuleForWord(o,s);r.push(i);let l=_.regexEveryMacroForWord(o,s);r.push(l);let a=await q(r,e.wsFolderPath,s,e.excludeFiles),c=[];for(let d of a){let u=d.symbol;if(e.labelsExcludes.includes(u))continue;let p=new le.Location(d.uri,d.range),g=new le.SymbolInformation(u,void 0,"",p);c.push(g)}return c}};var z=P(require("vscode"));var V=class{static regexCommentSingleLine(e){let t=new Set([";","//"]);e&&t.add(e);let o="^("+Array.from(t).join("|")+")";return new RegExp(o)}static regexCommentMultipleStart(){return/^\/\*/}static regexCommentMultipleEnd(){return/\*\//}static regexModuleStart(){return/\s+module\b/i}static regexModuleEnd(){return/\s+endmodule\b/i}static regexStructStart(){return/\s+struct\b/i}static regexStructEnd(){return/\s+ends\b/i}static regexMacroStart(){return/\s+macro\b/i}static regexMacroEnd(){return/\s+endm\b/i}};var We=class{provideFoldingRanges(e,t,s){let o=f.getConfigForDoc(e);if(!o?.enableFolding)return[];let i=e.getText().split(`
`),l=[],a=m.regexLabel(o,"asm-collection"),c=V.regexCommentMultipleStart(),d=V.regexCommentMultipleEnd(),u=V.regexCommentSingleLine(f.globalToggleCommentPrefix),p=-1,g,b=i.length;for(let h=0;h<b;h++){let v=i[h];switch(g){case"/*":d.exec(v)&&(this.addRange(l,p,h,z.FoldingRangeKind.Comment),g=void 0);break;case";":u.exec(v)||(h--,this.addRange(l,p,h,z.FoldingRangeKind.Comment),g=void 0);break;case"label":default:{let x;a.exec(v)?x="label":u.exec(v)?x=";":c.exec(v)&&(x="/*"),x&&(g==="label"&&this.addRange(l,p,h-1,z.FoldingRangeKind.Region),p=h,g=x);break}}}if(g){let h=g==="label"?z.FoldingRangeKind.Region:z.FoldingRangeKind.Comment;this.addRange(l,p,b-1,h)}return oe(i),this.addRangesForRegex(i,l,V.regexModuleStart(),V.regexModuleEnd()),this.addRangesForRegex(i,l,V.regexStructStart(),V.regexStructEnd()),this.addRangesForRegex(i,l,V.regexMacroStart(),V.regexMacroEnd()),l}addRange(e,t,s,o){if(s>t){let r=new z.FoldingRange(t,s,o);e.push(r)}}addRangesForRegex(e,t,s,o){let r=[],i=-1,l=e.length-1;for(let a of e)if(i++,s.exec(a)){let c=new z.FoldingRange(i,l,z.FoldingRangeKind.Region);r.push(c),t.push(c)}else if(o.exec(a)){let c=r.pop();c&&(c.end=i)}}};function ko(n){w.Init(n),j.Init(n),Z.checkVersion(),ie.updateVersion()&&new ie,n.subscriptions.push(R.commands.registerCommand("asm-code-lens.whatsNew",()=>new ie)),Ae=new ue,n.subscriptions.push(R.window.registerWebviewViewProvider("asm-code-lens.calcview-explorer",Ae,{webviewOptions:{retainContextWhenHidden:!0}})),Ne=new ue,n.subscriptions.push(R.window.registerWebviewViewProvider("asm-code-lens.calcview-debug",Ne,{webviewOptions:{retainContextWhenHidden:!0}})),Ke(n),n.subscriptions.push(R.workspace.onDidChangeConfiguration(t=>{Ke(n,t)})),n.subscriptions.push(R.workspace.onDidChangeWorkspaceFolders(t=>{Ke(n)})),R.commands.registerCommand("asm-code-lens.find-labels-with-no-reference",async()=>{let s=R.window.activeTextEditor?.document;if(!s)return;let o=s.languageId;if(o!="asm-collection"&&o!="asm-list-file")return;let r=f.getConfigForDoc(s);r&&await Ie.findLabelsWithNoReference(r,o)})}function Ke(n,e){e&&(e.affectsConfiguration("asm-code-lens.hexCalculator.hexPrefix")||e.affectsConfiguration("asm-code-lens.donated"))&&(Ae&&Ae.setMainHtml(),Ne&&Ne.setMainHtml(),Z.donatedPreferencesChanged()),B(Xe,n),B($e,n),B(Ze,n),B(Be,n),B(Ye,n),B(Qe,n),B(eo,n),B(oo,n),B(to,n),f.init();let t=[{scheme:"file",language:"asm-collection"},{scheme:"file",language:"asm-list-file"}];if(f.globalEnableCodeLenses){let o=new Ee;Xe=R.languages.registerCodeLensProvider(t,o),n.subscriptions.push(Xe)}f.globalEnableHovering&&($e=R.languages.registerHoverProvider(t,new Ce),n.subscriptions.push($e)),f.globalEnableCompletions&&(Ze=R.languages.registerCompletionItemProvider(t,new ye),n.subscriptions.push(Ze)),f.globalEnableGotoDefinition&&(Be=R.languages.registerDefinitionProvider(t,new Le),n.subscriptions.push(Be)),f.globalEnableFindAllReferences&&(Ye=R.languages.registerReferenceProvider(t,new we),n.subscriptions.push(Ye)),f.globalEnableRenaming&&(Qe=R.languages.registerRenameProvider(t,new Fe),n.subscriptions.push(Qe)),f.globalEnableOutlineView&&(eo=R.languages.registerDocumentSymbolProvider(t,new Se),n.subscriptions.push(eo)),f.globalEnableWorkspaceSymbols&&(oo=R.languages.registerWorkspaceSymbolProvider(new Te),n.subscriptions.push(oo)),to=R.languages.registerFoldingRangeProvider({scheme:"file",language:"asm-collection"},new We),n.subscriptions.push(to),R.languages.setLanguageConfiguration("asm-collection",{comments:{lineComment:f.globalToggleCommentPrefix,blockComment:["/*","*/"]}}),ro(f.globalToggleCommentPrefix);let s=[["{","}"],["[","]"],["(",")"]];f.globalEnablePushPopMatching&&s.push(["push","pop"]),R.languages.setLanguageConfiguration("asm-collection",{brackets:s})}function B(n,e){if(n){n.dispose();let t=e.subscriptions.indexOf(n);e.subscriptions.splice(t,1)}}var Ae,Ne,Xe,$e,Ze,Be,Ye,Qe,eo,oo,to;0&&(module.exports={activate});
