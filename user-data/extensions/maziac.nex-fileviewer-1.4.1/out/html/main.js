(()=>{var Ne=Object.create;var ee=Object.defineProperty;var Oe=Object.getOwnPropertyDescriptor;var ke=Object.getOwnPropertyNames;var De=Object.getPrototypeOf,He=Object.prototype.hasOwnProperty;var G=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var Ie=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ke(e))!He.call(r,i)&&i!==t&&ee(r,i,{get:()=>e[i],enumerable:!(n=Oe(e,i))||n.enumerable});return r};var Ae=(r,e,t)=>(t=r!=null?Ne(De(r)):{},Ie(e||!r||!r.__esModule?ee(t,"default",{value:r,enumerable:!0}):t,r));var ce=G(M=>{"use strict";M.__esModule=!0;M.GifWriter=M.IndexedColorImage=void 0;var Ge=function(){function r(e,t,n){this.width=e.width,this.height=e.height,this.data=t,this.paletteData=n}return r}();M.IndexedColorImage=Ge;var Ve=function(){function r(){this.__out=[],this.__remNumBits=0,this.__remVal=0}return r.prototype.push=function(e,t){for(;t>0;)this.__remVal=(e<<this.__remNumBits&255)+this.__remVal,t+this.__remNumBits>=8?(this.__out.push(this.__remVal),t=t-(8-this.__remNumBits),e=e>>8-this.__remNumBits,this.__remVal=0,this.__remNumBits=0):(this.__remNumBits=t+this.__remNumBits,t=0)},r.prototype.flush=function(){this.push(0,8),this.__remNumBits=0,this.__remVal=0;var e=this.__out;return this.__out=[],e},r}();function $e(r,e){var t=new Ve,n=1<<e,i=n+1,a=0,s=0,l=Object.create(null);function o(){a=i+1,s=e+1,l=Object.create(null)}o(),t.push(n,s);for(var f="",m=0,h=r.length;m<h;++m){var v=r[m],x=String.fromCharCode(v);x in l||(l[x]=v);var C=f;f+=x,f in l||(t.push(l[C],s),a<=4095?(l[f]=a,a===1<<s&&s++,a++):(t.push(n,s),o(),l[x]=v),f=x)}return t.push(l[f],s),t.push(i,s),t.flush()}var We=function(){function r(e){this.__os=e}return r.prototype.__writeInt2=function(e){this.__os.writeBytes([e&255,e>>8&255])},r.prototype.__writeDataSubBlocks=function(e){for(var t=this.__os,n=0,i;n<(i=Math.min(e.length,n+254));){var a=e.slice(n,i);t.writeByte(a.length),t.writeBytes(a),n=i}},r.prototype.__writeBlockTerminator=function(){this.__os.writeByte(0)},r.prototype.writeHeader=function(){var e=this.__os;e.writeBytes([71,73,70]),e.writeBytes([56,57,97])},r.prototype.writeTrailer=function(){this.__os.writeByte(59)},r.prototype.writeLogicalScreenInfo=function(e,t){var n,i,a;t||(t={});var s=(n=t.sizeOfColorTable)!==null&&n!==void 0?n:t.colorTableData?this.__calcSizeOfColorTable(t.colorTableData):7,l=(i=t.bgColorIndex)!==null&&i!==void 0?i:0,o=(a=t.pxAspectRatio)!==null&&a!==void 0?a:0;this.__writeLogicalScreenDescriptor(e,!!t.colorTableData,!!t.colorTableSortFlag,s,l,o),t.colorTableData&&this.__writeColorTable(t.colorTableData,s)},r.prototype.__calcSizeOfColorTable=function(e){for(var t=e.length/3,n=0,i=2;i<t;)n++,i=i<<1;return n},r.prototype.__writeLogicalScreenDescriptor=function(e,t,n,i,a,s){var l=this.__os;this.__writeInt2(e.width),this.__writeInt2(e.height),l.writeByte((t?128:0)|112|(n?8:0)|i),l.writeByte(a),l.writeByte(s)},r.prototype.writeTableBasedImage=function(e,t){t||(t={});var n=!0,i=this.__calcSizeOfColorTable(e.paletteData);this.__writeImageDescriptor(e,n,i,t),n&&this.__writeColorTable(e.paletteData,n?i:0),this.__writeImageData(e.data,i+1)},r.prototype.writeTableBasedImageWithGraphicControl=function(e,t){this.__writeGraphicControlExtension(t),this.writeTableBasedImage(e,t)},r.prototype.__writeImageDescriptor=function(e,t,n,i){var a,s,l=this.__os;l.writeByte(44);var o=(a=i?.leftPosition)!==null&&a!==void 0?a:0;this.__writeInt2(o);var f=(s=i?.topPosition)!==null&&s!==void 0?s:0;this.__writeInt2(f),this.__writeInt2(e.width),this.__writeInt2(e.height),l.writeByte((t?128:0)|0|0|0|n)},r.prototype.__writeImageData=function(e,t){var n=this.__os;t===1&&(t=2);var i=$e(e,t);n.writeByte(t),this.__writeDataSubBlocks(i),this.__writeBlockTerminator()},r.prototype.__writeColorTable=function(e,t){var n=this.__os;n.writeBytes(e);for(var i=3*Math.pow(2,t+1)-e.length,a=[];--i>=0;)a.push(0);n.writeBytes(a)},r.prototype.__writeGraphicControlExtension=function(e){var t,n;e||(e={});var i=this.__os,a=Math.round(((t=e.delayTimeInMS)!==null&&t!==void 0?t:0)/10),s=(n=e.disposalMethod)!==null&&n!==void 0?n:2,l,o;e.transparentColorIndex!==void 0&&e.transparentColorIndex>=0?(l=e.transparentColorIndex&255,o=1):(l=0,o=0),i.writeBytes([33,249,4]),i.writeByte(0|s<<2|0|o),this.__writeInt2(a),i.writeByte(l),i.writeByte(0)},r.prototype.writeLoopControlInfo=function(e){this.__os.writeBytes([33,255,11,78,69,84,83,67,65,80,69,50,46,48,3,1,e&255,e>>8&255,0])},r}();M.GifWriter=We});var de=G(W=>{"use strict";W.__esModule=!0;W.selectKthElem=void 0;function ze(r,e){return Ue(r,0,r.length-1,e)}W.selectKthElem=ze;function Ue(r,e,t,n){for(;;){var i=Math.floor((t+e)/2),a=Xe(r,e,t,i),s=a-e+1;if(n===s)return r[a];n<s?t=a-1:(n=n-s,e=a+1)}}function q(r,e,t){var n=r[e];r[e]=r[t],r[t]=n}function Xe(r,e,t,n){var i=r[n];q(r,n,t);for(var a=e,s=e;s<t;++s)r[s]<=i&&(q(r,a,s),a=a+1);return q(r,t,a),a}});var fe=G(z=>{"use strict";z.__esModule=!0;z.MedianCutColorReducer=void 0;var Ze=de();function Ke(r,e){var t=0,n=!1,i=-1,a=-1,s=0;return e.forEach(function(l,o){var f=Math.floor(Math.pow(r.red-l.red,2)+Math.pow(r.green-l.green,2)+Math.pow(r.blue-l.blue,2));f==0?(n=!0,i=o,a=o):(t==0||f<t)&&(a=o,t=f)}),n?i:a}var Ye=function(){function r(e){this.colors=e;var t=255,n=0,i=255,a=0,s=255,l=0;e.forEach(function(o){o.red<t&&(t=o.red),o.red>n&&(n=o.red),o.green<i&&(i=o.green),o.green>a&&(a=o.green),o.blue<s&&(s=o.blue),o.blue>l&&(l=o.blue)}),this.__minR=t,this.__maxR=n,this.__minG=i,this.__maxG=a,this.__minB=s,this.__maxB=l}return r.prototype.divide=function(){var e=this.largestEdge(),t=this.median(e),n=this.divideBy(e,t);return n},r.prototype.divideBy=function(e,t){var n=[],i=[];return this.colors.forEach(function(a){a[e]<t?n.push(a):i.push(a)}),n.length>0&&i.length>0?[new r(n),new r(i)]:[]},r.prototype.median=function(e){for(var t=[],n=this.colors,i=0,a=n.length;i<a;++i)t.push(n[i][e]);var s=Ze.selectKthElem(t,Math.floor(t.length/2)+1);return s},r.prototype.largestEdge=function(){var e=(this.__maxR-this.__minR)*1,t=(this.__maxG-this.__minG)*.8,n=(this.__maxB-this.__minB)*.5;return t>=n?e>=t?"red":"green":e>=n?"red":"blue"},r.prototype.getNumberOfColors=function(){return this.colors.length},r.prototype.average=function(){var e=0,t=0,n=0;this.colors.forEach(function(a){e+=a.red,t+=a.green,n+=a.blue});var i=this.colors.length;return{red:Math.floor(e/i),green:Math.floor(t/i),blue:Math.floor(n/i)}},r}(),qe=function(){function r(e,t){this.__palette=[],this.__colorReductionMap={},this.__imageData=e,this.__maxPaletteSize=t||255}return r.prototype.process=function(){var e=this.__imageData,t=this.__maxPaletteSize,n=this.__extractColors(e),i=this.__medianCut(n,t),a=[],s=Object.create(null);i.forEach(function(o,f){a.push(o.average()),o.colors.forEach(function(m){for(var h=(m.red<<16|m.green<<8|m.blue<<0).toString(16);6-h.length;)h="0"+h;s[h]=f})}),this.__palette=a,this.__colorReductionMap=s;var l=[];return a.forEach(function(o){l.push(o.red),l.push(o.green),l.push(o.blue)}),l},r.prototype.map=function(e,t,n){for(var i=(e<<16|t<<8|n<<0).toString(16);6-i.length;)i="0"+i;return i in this.__colorReductionMap||(this.__colorReductionMap[i]=Ke({red:e,green:t,blue:n},this.__palette)),this.__colorReductionMap[i]},r.prototype.__extractColors=function(e){for(var t=e.width*e.height,n={},i=[],a=0;a<t;++a){for(var s=e.data[a*4+0],l=e.data[a*4+1],o=e.data[a*4+2],f=(s<<16|l<<8|o<<0).toString(16);6-f.length;)f="0"+f;n[f]||(n[f]=!0,i.push({red:s,green:l,blue:o}))}return i},r.prototype.__medianCut=function(e,t){var n=new Ye(e),i=this.__divideUntil([n],t);return i},r.prototype.__divideUntil=function(e,t){for(;!(e.length>=t);){var n=this.__getLargestCube(e),i=n.divide();if(i.length<2)break;e=e.filter(function(a){return a!==n}).concat(i)}return e},r.prototype.__getLargestCube=function(e){var t,n=0;if(e.forEach(function(i){var a=i.getNumberOfColors();a>n&&(t=i,n=a)}),t===void 0)throw Error("`cubes` must have one or more elements.");return t},r}();z.MedianCutColorReducer=qe});var me=G(H=>{"use strict";var je=H&&H.__createBinding||(Object.create?function(r,e,t,n){n===void 0&&(n=t),Object.defineProperty(r,n,{enumerable:!0,get:function(){return e[t]}})}:function(r,e,t,n){n===void 0&&(n=t),r[n]=e[t]}),ue=H&&H.__exportStar||function(r,e){for(var t in r)t!=="default"&&!e.hasOwnProperty(t)&&je(e,r,t)};H.__esModule=!0;ue(ce(),H);ue(fe(),H)});var te=acquireVsCodeApi();var p,u,g,b,re,Me,ne,P,Pe;function k(r){r||console.log("Error!")}function T(r){let e="";return[].slice.call(new Uint8Array(r)).forEach(n=>e+=String.fromCharCode(n)),window.btoa(e)}function d(r,e="",t=""){let n=document.createElement("DETAILS");n.classList.add("nomarker");let i=y(u,4),a=y(g,4),s=`
<summary>
	<div class="offset" title="Offset
Hex: ${i}">${u}</div>
	<div class="size" title="Size
Hex: ${a}">${g}</div>
	<div class="name">${r}</div>
	<div class="value">${e}</div>
	<div class="description">${t}</div>
</summary>
<div class="indent"></div>
`;n.innerHTML=s;let l=n.childNodes;re=l[3];let f=l[1].childNodes;return Me=f[5],ne=f[7],P=f[9],Pe=P.childNodes[3],b.appendChild(n),n}function E(r){ae(),N(ie(r)),oe()}function ie(r){return r.replace(/\n/g,"<br>")}function ae(){b.lastChild.classList.remove("nomarker"),b=re}function oe(){b=b.parentNode.parentNode}function L(r){ae();let e=u,t=g;g=0,r(),u=e,g=t,oe()}function w(r){let e=b.lastChild;e.classList.remove("nomarker"),e.setAttribute("data-index",u.toString()),r&&e.addEventListener("toggle",function t(n){b=n.target;let i=b.getAttribute("data-index");u=parseInt(i),g=0,r(),this.removeEventListener("toggle",t)})}function N(r){let e=document.createElement("DIV");e.innerHTML=ie(r),e.classList.add("gray"),b.appendChild(e)}function A(r){ne.title=r}function y(r,e){return r==null?"".padStart(e,"?"):r.toString(16).toUpperCase().padStart(e,"0")}function c(r){u+=g,g=r}function se(r){g=r}function F(){let r=p[u],e=1;for(let t=1;t<g;t++)e*=256,r+=e*p[u+t];return r}function _(){return F().toString()}function V(){let e=F().toString(16).toUpperCase();return e=e.padStart(g*2,"0"),e}function Z(){return"0x"+V()}function D(r){return F()&1<<r?"1":"0"}function $(r,e){let t=r.toString(2);return t=t.padStart(e*8,"0"),t=t.replace(/.{4}/g,"$&_"),t=t.substring(0,t.length-1),t}function K(){let r=F();return $(r,g)}function Y(){let r="";for(let e=0;e<g;e++){let t=p[u+e];r+=String.fromCharCode(t)}return r}function B(r=0,e="Relative Offset"){let t="",n="";try{for(let i=0;i<g;i++){let a=i%16,s=u+i,l=r+i,o=p[s],f=y(o,2),m=o.toString(),h=y(l,4);if(a==0){t+=n,n="</div>";let x=i+1;for(;x<g&&o==p[u+x];x++);let C=x-x%16;if(C>i+16){x==g?i=g-1:i=C-1;let X=y(r+i,4),Fe="Offset (hex): "+y(s,4)+"-"+y(u+i,4)+`
Value (dec): `+m,Te="Relative offset (dec): "+l+"-"+(r+i)+`
Value (dec): `+m;t+="<div>",t+='<span class="indent mem_offset" title="'+Fe+'">'+s+"-"+(u+i)+"</span>",t+='<span class="mem_offset" title="'+Te+'"> (0x'+h+"-0x"+X+"): </span>",t+='<span title="Value (dec): '+m+'"> contain all '+f+"</span>";continue}let I=y(s,4);t+=`<div class="mem_dump">
					<div class="indent mem_offset" title = "Offset
Hex: ${I}">${s}</div>
				<div class="mem_rel_offset" title="${e}
Dec: ${l}">(0x${h})</div>
				`}let v="Offset (hex): "+y(s,4)+`
Offset (dec): `+s+`
Relative offset (hex): `+h+`
Relative offset (dec): `+l+`
Value (dec): `+m;t+='<div class="mem_byte" title="'+v+'">'+f+"&nbsp;</div>"}t+=n}catch(i){t+=n,t+='<div class="error indent">Error while parsing.</div>'}b.innerHTML+=t}function le(r){p=r,u=0,g=0,b=document.getElementById("div_root")}te.postMessage({command:"ready"});var U=Ae(me()),S=class{constructor(){this.buffer=[]}writeByte(e){this.buffer.push(e)}writeBytes(e){Array.prototype.push.apply(this.buffer,e)}static createGifFromArray(e,t,n,i,a){let s=new U.IndexedColorImage({width:e,height:t},n,i),l=new S,o=new U.GifWriter(l);return o.writeHeader(),o.writeLogicalScreenInfo({width:s.width,height:s.height}),o.writeTableBasedImageWithGraphicControl(s,{transparentColorIndex:a}),o.writeTrailer(),l.buffer}};var R=class{constructor(e,t){this.memory=e,this.ulaScreenAddressOffset=t}setUlaScreenAddress(e){this.ulaScreenAddressOffset=e}getUlaScreen(){let e=this.createPixels(),t=R.getZxPalette();return S.createGifFromArray(R.SCREEN_WIDTH,R.SCREEN_HEIGHT,e,t)}createPixels(){let e=this.memory,t=this.ulaScreenAddressOffset,n=t+R.SCREEN_HEIGHT*R.SCREEN_WIDTH/8,i=new Array(R.SCREEN_HEIGHT*R.SCREEN_WIDTH),a=0,s=0,l=0;for(let o=0;o<R.SCREEN_HEIGHT;o++){s=t+((o&7)<<8|(o&192)<<5|(o&56)<<2),l=n+((o&248)<<2);for(let f=0;f<R.SCREEN_WIDTH/8;f++){let m=e[s],h=e[l],v=128;for(;v;){let x=m&v,C=(h&64)>>>3;x?C|=h&7:C|=h>>>3&7,i[a]=C,v>>>=1,a++}s++,l++}}return i}static getZxPalette(){return[0,0,0,0,0,215,215,0,0,215,0,215,0,215,0,0,215,215,215,215,0,215,215,215,0,0,0,0,0,255,255,0,0,255,0,255,0,255,0,0,255,255,255,255,0,255,255,255]}},O=R;O.SCREEN_HEIGHT=192,O.SCREEN_WIDTH=256,O.SCREEN_SIZE=R.SCREEN_HEIGHT*R.SCREEN_WIDTH/8+R.SCREEN_HEIGHT/8*R.SCREEN_WIDTH/8;function he(r){return r>=6?r:[5,2,0,1,3,4][r]}function pe(){switch(F()){case 0:return"BLACK";case 1:return"BLUE";case 2:return"RED";case 3:return"MAGENTA";case 4:return"GREEN";case 5:return"CYAN";case 6:return"YELLOW";case 7:return"WHITE"}return"UNKNOWN"}function j(r,e){if(e)switch(r){case 0:return[0,0,0];case 1:return[0,0,255];case 2:return[255,0,0];case 3:return[255,0,255];case 4:return[0,255,0];case 5:return[0,255,255];case 6:return[255,255,0];case 7:return[255,255,255]}else switch(r){case 0:return[0,0,0];case 1:return[0,0,215];case 2:return[215,0,0];case 3:return[215,0,215];case 4:return[0,215,0];case 5:return[0,215,215];case 6:return[215,215,0];case 7:return[215,215,215]}return k(!1),[0,0,0]}function xe(){try{if(u+O.SCREEN_SIZE>p.length)throw Error();let e=new O(p,u).getUlaScreen(),t=T(e);b.innerHTML+='<img width="500px" style="image-rendering:pixelated" src="data:image/gif;base64,'+t+'">'}catch(r){b.innerHTML+='<div class="error">Error converting image.</div>'}}function be(){let r="0".charCodeAt(0),e=String.fromCharCode(r+p[u])+".";return e+=String.fromCharCode(r+p[u+1])+".",e+=String.fromCharCode(r+p[u+2]),e}function ve(){let r="";for(let e=0;e<g;e++)if(p[u+e]==1&&(r+=e+" ",r.length>15))return"...";return r}function J(){let r=new Array(768);for(let e=0;e<g/2;e++){let t=u+2*e,n=p[t],i=p[t+1],a=(n>>5)*32,s=(n>>2&7)*32,l=((n<<1&6)+(i&1))*32,o=3*e;r[o]=a,r[o+1]=s,r[o+2]=l}return r}function ge(){let r=new Array(768);for(let e=0;e<256;e++){let t=(e>>5)*32,n=(e>>2&7)*32,i=(e<<1&6)*32,a=3*e;r[a]=t,r[a+1]=n,r[a+2]=i}return r}function Q(r,e){let t=new Array(768);for(let n=0;n<256;n++){let i=3*n,a=3*(n+e&255);t[a]=r[i],t[a+1]=r[i+1],t[a+2]=r[i+2]}return t}function _e(){let r="";try{for(let e=0;e<g;e+=2){let t=u+e,n=e/2,i=p[t],a=p[t+1],s=i>>5,l=i>>2&7,o=(i<<1&6)+(a&1),f=a>>7,m=y(t,4),h=256*a+i,v=$(h,2);r+=`<div class="mem_dump">
					<div class="indent mem_offset" title = "Offset
Hex: ${m}">${t}</div>
				<div class="mem_rel_offset"> [${n}]</div>`;let x=y(h,4),C="Bin: P000_000B_RRRG_GGBB = "+v;r+='<div class="mem_byte" title="'+C+'">0x'+x+":</div>",r+='<div class="mem_byte">R='+s+",</div>",r+='<div class="mem_byte">G='+l+",</div>",r+='<div class="mem_byte">B='+o+",</div>",r+='<div class="mem_byte">P='+f+"</div>";let I=y(s*32,2)+y(l*32,2)+y(o*32,2);r+='<div class="mem_byte" style="background:#'+I+'" title="#'+I+'">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>',r+="</div>"}}catch(e){r+="</div>",r+='<div class="error indent">Error while parsing.</div>'}b.innerHTML+=r}function ye(){k(g==512);try{let r=new Array(256);for(let o=0;o<256;o++)r[o]=o;let e=J(),t=S.createGifFromArray(16,16,r,e),n=T(t),i=256,a='<img usemap="#palette_map" width="'+i+'px" style="image-rendering:pixelated" src="data:image/gif;base64,'+n+'">';a+='<map name="palette_map">';let s=i/16,l=0;for(let o=0;o<16;o++)for(let f=0;f<16;f++){let m=l*3,h=`Index: ${l}
R=${e[m]/32}
G=${e[m+1]/32}
B=${e[m+2]/32}`;a+='<area title="'+h+'" shape="rect" coords="'+f*s+","+o*s+","+(f+1)*s+","+(o+1)*s+'">',l++}a+="</map>",b.innerHTML+=a}catch(r){b.innerHTML+='<div class="error">Error converting image.</div>'}}function Ee(r){try{if(u+49152>p.length)throw Error();let e=p.slice(u,u+49152),t=S.createGifFromArray(256,192,e,r),n=T(t);b.innerHTML+='<img class="load_screen" style="image-rendering:pixelated" src="data:image/gif;base64,'+n+'">'}catch(e){b.innerHTML+='<div class="error">Error converting image.</div>'}}function Ce(r){try{if(u+81920>p.length)throw Error();let e=new Array(81920),t=u;for(let a=0;a<320;a++)for(let s=0;s<256;s++)e[a+s*320]=p[t++];let n=S.createGifFromArray(320,256,e,r),i=T(n);b.innerHTML+='<img class="load_screen_layer2_320_640" style="image-rendering:pixelated" src="data:image/gif;base64,'+i+'">'}catch(e){b.innerHTML+='<div class="error">Error converting image.</div>'}}function we(r){try{if(u+81920>p.length)throw Error();let e=new Array(640*256),t=u;for(let a=0;a<640;a+=2)for(let s=0;s<256;s++){let l=p[t++],o=a+s*640;e[o]=l>>4,e[o+1]=l&15}let n=S.createGifFromArray(640,256,e,r),i=T(n);b.innerHTML+='<img class="load_screen_layer2_320_640" style="image-rendering:pixelated" src="data:image/gif;base64,'+i+'">'}catch(e){b.innerHTML+='<div class="error">Error converting image.</div>'}}function Re(r){try{if(u+12288>p.length)throw Error();let e=p.slice(u,u+12288),t=S.createGifFromArray(128,96,e,r),n=T(t);b.innerHTML+='<img class="load_screen" style="image-rendering:pixelated" src="data:image/gif;base64,'+n+'">'}catch(e){b.innerHTML+='<div class="error">Error converting image.</div>'}}function Se(r){let e=~r&7;try{if(u+12288>p.length)throw Error();let t=new Array;t.push(...j(e,!0)),t.push(...j(r,!0));let n=p.slice(u,u+12288),i=new Array(8*12288),a=0,s=0,l=12288/2;for(let m=0;m<192;m++){s=(m&7)<<8|(m&192)<<5|(m&56)<<2;for(let h=0;h<32;h++){let v=n[s];for(let x=7;x>=0;x--)i[a+x]=v&1,v>>=1;a+=8,v=n[s+l];for(let x=7;x>=0;x--)i[a+x]=v&1,v>>=1;a+=8,s++}}let o=S.createGifFromArray(512,192,i,t),f=T(o);b.innerHTML+='<img class="load_screen_hires" style="image-rendering:pixelated" src="data:image/gif;base64,'+f+'">'}catch(t){b.innerHTML+='<div class="error">Error converting image.</div>'}}function Le(){try{if(u+12288>p.length)throw Error();let r=O.getZxPalette(),e=p.slice(u,u+12288),t=new Array(8*12288),n=0,i=0,a=12288/2;for(let o=0;o<192;o++){i=(o&7)<<8|(o&192)<<5|(o&56)<<2;for(let f=0;f<32;f++){let m=e[i],h=e[i+a],v=128;for(;v;){let x=m&v,C=(h&64)>>>3;x?C|=h&7:C|=h>>>3&7,t[n]=C,v>>>=1,n++}i++}}let s=S.createGifFromArray(256,192,t,r),l=T(s);b.innerHTML+='<img class="load_screen" style="image-rendering:pixelated" src="data:image/gif;base64,'+l+'">'}catch(r){b.innerHTML+='<div class="error">Error converting image.</div>'}}function Be(){let r="";try{let e="Relative Offset";for(let t=0;t<g;t+=2){let n=u+t,i=t/2,a=256*p[n]+p[n+1],s=$(a,2),l=y(i,4);if(a==0){let m=t+2;for(;m<g&&p[u+m]==0;m++);let h=(m-t>>>1)-1;if(h>0){let v=y(n,4),x=u+t+2*h,C=y(x,4),I=t+2*h,X=y(I,4);r+=`<div class="mem_dump">
				<div class="indent mem_offset" title = "Offset
Hex: ${v}-${C}">${n}-${x}</div>
			<div class="mem_rel_offset" title="${e}
Hex: ${l}-${X}">[${i}...${I}]:</div>`,r+='<div class="mem_byte">'+s+"</div>",r+='<div class="copper_cmd">&nbsp;= All NOOP</div>',t+=2*h;continue}}let o=y(n,4);r+=`<div class="mem_dump">
				<div class="indent mem_offset" title = "Offset
Hex: ${o}">${n}</div>
			<div class="mem_rel_offset" title="${e}
Hex: ${l}">[${i}]:</div>
			`,r+='<div class="mem_byte">'+s+"</div>";let f;if(a==0)f="NOOP";else if(a==65535)f="HALT";else if(a&32768){let m=a&511,h=a>>>9&63;f=`WAIT v==${m} (0x${y(m,2)}) AND h==${h} (0x${y(h,2)})`}else{let m=a&255,h=a>>>8&127;f=`MOVE ${m} (0x${y(m,2)}) TO REG ${h} (0x${y(h,2)})`}r+='<div class="copper_cmd">&nbsp;= '+f+"</div>",r+="</div>"}}catch(e){r+="</div>",r+='<div class="error indent">Error while parsing.</div>'}b.innerHTML+=r}function Je(){let r="<div>ZX NEX File View.</div>",e=p.length;r+="<div><b>Length:</b> "+e+"</div>",r+="<br>",b.innerHTML=r;try{let t,n,i,a;c(512),d("Header").open=!0,L(()=>{c(4);let o=Y();d("NEXT",o),o!="Next"&&(P.classList.add("error"),P.textContent="Not a NEX file."),c(4);let f=Y(),m;f=="V1.3"&&(m="(unofficial)"),d("VERSION",f,m),c(1);let h=F(),v;switch(h){case 0:v="768k";break;case 1:v="1792k";break;default:v=h.toString()}d("RAM_REQUIRED",v,"The required RAM."),E("0 = 768k, 1 = 1792k"),A("Dec: "+_()),c(1),d("NUM_BANKS",_(),"Number of 16k Banks to Load: 0-112"),c(1),n=F(),d("LOAD_SCREENS",K(),"Loading-screen blocks in file"),L(()=>{N(`
128 = no palette block, 64 = "flags 2" in V1.3 part of header define screen, 16 = Hi-Colour, 8 = Hi-Res, 4 = Lo-Res, 2 = ULA, 1 = Layer2

The loader does use common banks to load the graphics into, and show it from, i.e. bank5 for all ULA related modes and banks 9,10 and 11 for Layer2 graphics (loading these banks afterwards as regular bank will thus replace the shown data on screen).

Only Layer2, Tilemap and Lo-Res screens expect the palette block (unless +128 flag set). While one can include multiple screen data in single file (setting up all relevant bits), the recommended/expected usage is to have only one type of screen in NEX file.`),d("No palette block",D(7),"Bit 7"),d("flags 2",D(6),"Bit 6"),d("Unused",D(7),"Bit 5"),d("Hi-Colour",D(4),"Bit 4"),d("Hi-Res",D(3),"Bit 3"),d("Lo-Res",D(2),"Bit 2"),d("ULA",D(1),"Bit 1"),d("Layer 2",D(0),"Bit 0")}),c(1),d("BORDER_COLOR",pe(),"Border Color: 0-7"),A("Dec: "+_()),c(2),d("SP",Z(),"Stack pointer"),A("Dec: "+_()),c(2),d("PC",Z(),"Program counter"),E("0 = don't run, just load"),A("Dec: "+_()),c(2),d("NUM_FILES",_(),"Number of extra files"),E("Obsolete"),c(112),d("BANKS",ve(),"Array of included banks"),L(()=>{N("byte flag (0/1) of 16k banks included in the file - this array is in regular order 0..111, i.e. bank5 in file will set 1 to header byte at offset 18+5 = 23, but the 16kiB of data for bank 5 are first in the file (order of bank data in file is: 5,2,0,1,3,4,6,7,8,9,10,...,111)"),se(0);for(let x=0;x<112;x++)c(1),d("Bank"+x,_())}),c(1),d("LOAD_BAR",_(),'Layer2 "loading bar"'),E("0 = OFF, 1 = ON(works only in combination with Layer2 screen data) "),c(1),d("LOAD_COLOR",_(),'"Loading bar" color'),E('"Loading bar" color (0..255) (for 640x256x4 mode the byte defines pixels pair)'),c(1),d("LOAD_DELAY",_(),"Loading delay per bank"),E("Loading delay per bank (0..255 amount of frames), 0 = no delay"),c(1),d("START_DELAY",_(),"Start delay"),E("Start delay (0..255 amount of frames), 0 = no delay"),c(1),d("PRESERVE_NEXT_REGS",_(),"Preserve Next-Registers"),E("Preserve current Next-Registers values (0 = reset machine state, 1 = preserve)"),c(3),d("CORE_VERSION",be(),"Required core version"),L(()=>{N('Required core version, three bytes 0..15 "major", 0..15 "minor", 0..255 "subminor" version numbers. (core version is checked only when reported machine-ID is 10 = "Next", on other machine or emulator=8 the latest loaders will skip the check)'),c(1),d("MAJOR",_()),c(1),d("MINOR",_()),c(1),d("SUB_MINOR",_())}),c(1),a=F(),d("HIRES_COLOR",K(),"Timex HiRes 512x192 mode color"),E(`Timex HiRes 512x192 mode color, encoded as for port 255 = bits 5-3. I.e. values 0, 8, 16, .., 56 (0..7 * 8)
When screens 320x256x8 or 640x256x4 are used, this byte is re-used as palette offset for Layer 2 mode, values 0..15`),c(1),d("ENTRY_BANK",_(),"Bank to be mapped into slot 3"),E('Entry bank = bank to be mapped into slot 3 (0xC000..0xFFFF address space), the "Program Counter" (header offset +14) and "File handle address" (header offset +140) are used by NEX loader after the mapping is set (The default ZX128 has bank 0 mapped after reset, which makes zero value nice default).'),c(2),d("FILE_HANDLE_ADDR",V(),"File handle address"),E('0 = NEX file is closed by the loader, 1..0x3FFF values (1 recommended) = NEX loader keeps NEX file open and does pass the file handle in BC register, 0x4000..0xFFFF values (for 0xC000..0xFFFF see also "Entry bank") = NEX loader keeps NEX file open and the file handle is written into memory at the desired address.'),A("Dec: "+_()),k(u+g==142),f<="V1.2"?(c(370),d("RESERVED"),E("Reserved for future extensions."),w(()=>{c(370),B()})):(c(1),d("EXPBUS_ENABLE",_(),"Enable Expansion Bus"),E("0 = disable Expansion Bus by setting top four bits of Expansion Bus Enable Register ($80) to 0, 1 = do nothing (does apply only to cores 3.0.5+)"),c(1),d("HAS_CHECKSUM",_()),E("1 = Has checksum value, checksum algorithm is CRC-32C (Castagnoli), value itself is at the very end of the header block"),c(4),d("BANKS_OFFSET",V(),"File offset of first bank data"),E("File offset of first bank data (when loader is parsing known version, it should know where the banks start without this value, but it may use it for extra check whether the parsing of optional blocks between header and first bank was done correctly for files V1.3+, or it may even try to partially-load unknown future versions of NEX files by skipping unknown blocks between header and banks data, although that may lead to unexpected state for the app)"),A("Dec: "+_()),c(2),d("CLI_BUFFER_ADDR",_(),"CLI buffer address"),E('CLI buffer address (after "Entry bank" is paged in), 0 = no buffer'),c(2),d("CLI_BUFFER_SIZE",_(),"CLI buffer size"),E('When address and size are provided, the original argument line passed to NEX loader will be copied to defined buffer (and truncated to "size", shorter string may be zero/colon/enter terminated as any other BASIC line) and register DE is set to the buffer address. The maximum size is 2048 bytes (longer lines can be probably salvaged from Bank 5 memory if the NEX file is not loading that bank and the app code search for the original line on its own).'),c(1),i=F(),d("LOAD_SCREENS_2",_(),"Loading screen flags 2 "),E(`When first flag has bit6 +64 set (+128 no-palette is valid for new cases too, other old bits should be NOT mixed with new modes):
1 = Layer 2 320x256x8bpp, blocks: [512B palette +] 81920B data
2 = Layer 2 640x256x4bpp, blocks: [512B palette +] 81920B data
 (HiRes color value 0..15 is used as L2 palette offset - does apply to two new Layer 2 modes)
 For Layer 2 banks 9,10,11,12,13 are used to display the loading screen.
3 = Tilemode screen, block: [512B palette] (plus four configuration bytes in header at offset 154)
 Tilemap data are stored in regular (!) bank 5 - no specialized data block is used.`),c(1),t=F(),d("HAS_COPPER_CODE",_(),"Inclusion of copper code"),E('1 = Has copper code block, extra 2048B block after last screen data block, which will be set to Copper and the copper will be started with %01 control code (reset CPC to 0, and start). This can be used for example as "loading screen animation" feature (be aware the timing of load may vary greatly).'),c(4),d("TILE_SCR_CONFIG",_(),"Tilemode screen configuration"),E("When Tilemode screen: four bytes array, values to set NextRegs: $6B, $6C, $6E, $6F"),c(1),d("BIG_L2_BAR_POSY",_(),"Loading bar y-position"),E("When Layer 2 320x256 or 640x256 screen + loading bar: loading bar Y position (bar is 2px tall, so 254 is very bottom)"),c(349),d("RESERVED"),E("Reserved for future extensions, set to zero in older versions of file format."),w(()=>{c(349),B()}),c(4),d("CRC32C",_(),"Optional checksum"),E('Optional CRC-32C (Castagnoli) - is calculated by checksumming (initial value is zero) file content from offset 512 (after this field) till end of file, including the optional custom binary appended after regular NEX file. And then continuing with checksumming the first 508 bytes of the header (stopping ahead of this field). This is intended for PC tools working with NEX files, or extra check tool running on Next, but not for regular loading of NEX files (value is stored as "uint32_t" in little-endian way).')),k(u==512)});let s;if(!(n&128)&&(n&5||n&64&&i==3)?(c(512),s=J(),d("Palette"),L(()=>{N(`Optional palette (for Layer2, LoRes or Tilemap screen).
Palette consists of 512 bytes (256 palette items from index 0), in 9b colour format: first byte is RRRG_GGBB, second byte is P000_000B (P is priority flag for Layer 2 colours).`),c(512),ye(),d("As index array"),w(()=>{c(512),_e()})})):s=ge(),n&1&&(c(49152),d("LAYER2_LOAD_SCREEN","","Layer 2 loading screen").open=!0,L(()=>{N("Palette consists of 512 bytes (256 palette items from index 0), in 9b color format: first byte is RRRG_GGBB, second byte is P000_000B (P is priority flag for Layer 2 colours)."),c(49152),Ee(s),d("Memory dump"),w(()=>{c(49152),B()})})),n&2&&(c(6912),d("ULA_LOAD_SCREEN","","Classic ULA loading screen").open=!0,L(()=>{c(6912),xe(),d("Memory dump"),w(()=>{c(6912),B()})})),n&4&&(c(12288),d("LORES_LOAD_SCREEN","","LoRes (128x96) loading screen").open=!0,L(()=>{N("Palette consists of 512 bytes (256 palette items from index 0), in 9b color format: first byte is RRRG_GGBB, second byte is P000_000B (P is is not used for LoRes)."),c(12288),Re(s),d("Memory dump"),w(()=>{c(12288),B()})})),n&8){let o=a>>2&7;c(12288),d("HIRES_LOAD_SCREEN","","Timex HiRes (512x192) loading screen").open=!0,L(()=>{N("The Timex HiRes mode supports only 2 colors."),c(12288),Se(o),d("Memory dump"),w(()=>{c(12288),B()})})}if(n&16&&(c(12288),d("HICOL_LOAD_SCREEN","","Timex HiCol (8x1) loading screen").open=!0,L(()=>{N("HiCol modes uses more attributes. I.e. the attribute applies to 1 byte only."),c(12288),Le(),d("Memory dump"),w(()=>{c(12288),B()})})),n&64)switch(c(81920),i){case 1:d("LAYER2_320_LOAD_SCREEN","","Layer 2 320x256x8bpp, 1 byte per pixel").open=!0,L(()=>{c(81920);let o=a&15,f=Q(s,o);Ce(f),d("Memory dump"),w(()=>{c(81920),B()})});break;case 2:d("LAYER2_320_LOAD_SCREEN","","Layer 2 640x256x4bpp, 4 bits per pixel").open=!0,L(()=>{c(81920);let o=a&15,f=Q(s,o);we(f),d("Memory dump"),w(()=>{c(81920),B()})});break}t==1&&(c(2048),d("COPPER_CODE","","Copper code for copper loading-effects"),w(()=>{c(2048),Be()}));for(let o=0;o<112;o++){let f=he(o);p[18+f]==1&&(c(16384),d("BANK"+f,"","16k memory bank"),w(()=>{c(16384),B()}))}let l=p.length-u-g;k(l>=0),l>0&&(c(l),d("OPTIONAL_DATA","",'Optional binary data appended after "regular" NEX file content - custom format'),w(()=>{c(l),B()}))}catch(t){let n=p.length-u;k(n>=0),n>0&&(c(n),d("Remaining","","Remaining data after parsing error."),w(()=>{c(n),B()}))}}window.addEventListener("message",r=>{let e=r.data;switch(e.command){case"setData":le(e.snaData),Je();break}});})();
