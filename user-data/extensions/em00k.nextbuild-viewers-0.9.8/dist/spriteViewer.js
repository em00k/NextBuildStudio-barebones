(()=>{"use strict";var e={301:(e,t)=>{t.oj=function(e,t,r){const o=new Array(e.length);for(let i=0;i<r;i++)for(let n=0;n<t;n++){const a=i*t+n;o[(r-1-i)*t+n]=e[a]}return o},t.ge=function(e,t,r){const o=new Array(e.length);for(let i=0;i<r;i++)for(let r=0;r<t;r++){const n=i*t+r;o[i*t+(t-1-r)]=e[n]}return o},t.ih=function(e,t,r,o){const i=new Array(e.length),n=o%r;for(let o=0;o<r;o++)for(let a=0;a<t;a++){const s=o*t+a;i[(o+n+r)%r*t+a]=e[s]}return i},t.Si=function(e,t,r,o){const i=new Array(e.length),n=o%t;for(let o=0;o<r;o++)for(let r=0;r<t;r++){const a=o*t+r;i[o*t+(r+n+t)%t]=e[a]}return i},t.gH=function(e,t,r){const o=r,i=t,n=new Array(t*r);for(let i=0;i<r;i++)for(let r=0;r<t;r++){const a=i*t+r;n[(t-1-r)*o+i]=e[a]}return{newPixels:n,newWidth:o,newHeight:i}},t.cV=function(e,t,r){const o=r,i=t,n=new Array(t*r);for(let i=0;i<r;i++)for(let a=0;a<t;a++){const s=i*t+a;n[a*o+(r-1-i)]=e[s]}return{newPixels:n,newWidth:o,newHeight:i}},t.GT=function(e,t,r,o,i,n){const a=i*t+o;if(o<0||o>=t||i<0||i>=r||a<0||a>=e.length)return console.error(`[floodFill] Invalid start coordinates (${o}, ${i}) for dimensions ${t}x${r}.`),!1;const s=e[a];if(s===n)return!1;const l=[[o,i]];e[a]=n;let d=0;const c=t*r*2;let p=!0;for(;l.length>0;){if(d++>c)return console.error("[floodFill] Processed too many pixels, aborting."),p;const[o,i]=l.shift(),a=[[o,i-1],[o,i+1],[o-1,i],[o+1,i]];for(const[o,i]of a)if(o>=0&&o<t&&i>=0&&i<r){const r=i*t+o;e[r]===s&&(e[r]=n,l.push([o,i]),p=!0)}}return p}},362:(e,t)=>{t.nQ=i,t.jD=function(e){const t=e.startsWith("#")?e.substring(1):e;if(6!==t.length)return{r9:0,g9:0,b9:0};const r=parseInt(t.substring(0,2),16),o=parseInt(t.substring(2,4),16),i=parseInt(t.substring(4,6),16);return{r9:n(r),g9:n(o),b9:n(i)}},t.dK=function(e){const t=e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);if(!t)return null;const r=parseInt(t[1],10),o=parseInt(t[2],10),i=parseInt(t[3],10);return`#${r.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`},t.Fs=function(e,t,r){const o=function(e,t){const r=7&e.r9,o=7&e.g9,i=7&e.b9;return(r<<5|o<<2|i>>1&3)<<8|(t?1:0)<<7|1&i}({r9:e,g9:t,b9:r},!1);return[o>>8&255,255&o]};const r=[];for(let e=0;e<256;e++){const t=(224&e)>>5,o=(28&e)>>2,i=(3&e)<<1|((3&e)>0?1:0);r.push([t,o,i])}const o=[0,36,73,109,146,182,219,255];function i(e,t,r){const i=Math.max(0,Math.min(7,Math.round(e))),n=Math.max(0,Math.min(7,Math.round(t))),a=Math.max(0,Math.min(7,Math.round(r))),s=o[i],l=o[n],d=o[a];return`#${s.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}`}function n(e){let t=0,r=1/0;for(let i=0;i<o.length;i++){const n=Math.abs(e-o[i]);n<r&&(r=n,t=i)}return t}}},t={};function r(o){var i=t[o];if(void 0!==i)return i.exports;var n=t[o]={exports:{}};return e[o](n,n.exports,r),n.exports}var o=r(301),i=r(362);function n(e,t,r){if(!r||!t)return 0;const o=r.mode,i=r.paletteOffset;let n=e;return"sprite4"!==o&&"tile8x8"!==o||(n=i+e),n<0||n>=t.length||!t[n]?0:n}function a(e,t,r,o,i,n,a){if(console.log("[Renderer] populatePalettePicker START"),!e)return void console.error("[Renderer] Palette picker element not found!");if(e.innerHTML="",console.log("[Renderer] Cleared palettePicker innerHTML"),!t||!t.current||0===t.current.length)return void console.warn("[Renderer] No valid current palette data found in paletteState.");const s=t.current,l=Math.min(s.length,t.visibleSize);for(let t=0;t<l;t++){const o=s[t],a=document.createElement("div");a.className="color-swatch",a.style.backgroundColor=o.hex,a.dataset.colorIndex=t.toString(),a.draggable=!0;const l=parseInt(o.hex.substring(1,3),16),d=parseInt(o.hex.substring(3,5),16),c=parseInt(o.hex.substring(5,7),16),p=Math.round(7*l/255),u=Math.round(7*d/255),g=Math.round(3*c/255),m=(7&p)<<5|(7&u)<<2|(3&g)>>1,v=(1&g)<<7|(o.priority?128:0);a.title=`Index: ${t}\nHex: ${o.hex}\nRGB9 bytes: (${m}, ${v})\nRGB9: (${p},${u},${g})\nRGB24: (${l},${d},${c})\nPriority: ${o.priority}`,t===r.primaryColorIndex&&a.classList.add("primary-selected"),t===r.secondaryColorIndex&&a.classList.add("secondary-selected"),a.addEventListener("click",(e=>{e.ctrlKey?console.log(`[Renderer] Ignoring color selection click on index ${t} because Ctrl key is pressed`):i(t)})),a.addEventListener("contextmenu",(e=>{e.preventDefault(),n(t),window.colorCopyState||(window.colorCopyState={}),window.colorCopyState.isCopying=!0,window.colorCopyState.sourceIndex=t,console.log(`[Renderer] Right-click on color ${t} - ready for copy`)})),e.appendChild(a)}console.log("[Renderer] populatePalettePicker END - Added swatches")}function s(e,t,r,o,i,a){if(console.log(`[Renderer] >>> redrawSpriteGrid START (Mode: ${r.mode})`),!e||!t)return void console.log("[Renderer] redrawSpriteGrid END - Early exit (no container or spriteData)");if(e.innerHTML="",!t.sprites)return void console.log("[Renderer] redrawSpriteGrid END - Early exit (no sprites array)");const d=r.spriteBrush||{width:1,height:1},c=d.width>0?d.width:1;console.log(`[Renderer redrawSpriteGrid] Brush width: ${d.width}, Grid column count: ${c}`),e.style.gridTemplateColumns=`repeat(${c}, 1fr)`;const p=r.currentSprite;Math.floor(p/16),t.sprites.forEach((t=>{const c=document.createElement("div");c.className="sprite-box";let u=!1;for(let e=0;e<d.height;e++){for(let r=0;r<d.width;r++)if(t.index===p+r+e*d.width){u=!0;break}if(u)break}u&&c.classList.add("brush-area-sprite"),t.index===p&&c.classList.add("selected"),c.dataset.index=t.index.toString(),c.draggable=!0;const g=document.createElement("div");g.className="sprite-container",g.style.gridTemplateColumns=`repeat(${t.width}, 1fr)`,t.pixels.forEach((e=>{const t=document.createElement("div");t.className="sprite-pixel";const i=n(e,o,r);t.style.backgroundColor=o[i]?.hex||"#FF00FF",g.appendChild(t)}));const m=document.createElement("div");m.className="sprite-index",m.textContent=t.index.toString(),c.appendChild(g),c.appendChild(m),c.addEventListener("click",(e=>{const t=parseInt(c.dataset.index||"0",10);if(e.altKey)i.postMessage({command:"pasteSprite",targetIndex:t});else{if(a&&a.viewState&&a.spriteData){if(a.viewState.currentSprite===t)return;a.viewState.currentSprite=t;const e=document.querySelector(".sprites-grid");e&&s(e,a.spriteData,a.viewState,a.palette.current,i,a);const r=document.querySelector(".detail-container");r&&l(r,a.spriteData,a.viewState,a.palette.current,!a.palette.isCustom)}i.postMessage({command:"viewSprite",index:t})}})),c.addEventListener("contextmenu",(e=>{e.preventDefault();const t=parseInt(c.dataset.index||"0",10);e.ctrlKey&&e.shiftKey?i.postMessage({command:"removeSprite",index:t}):i.postMessage({command:"copySprite",sourceIndex:t})})),e.appendChild(c)}));const u=document.createElement("div");u.className="add-sprite-box",u.title="Add new sprite",u.innerHTML='\n        <div class="add-sprite-plus">+</div>\n        <div class="add-sprite-text">New</div>\n    ',u.addEventListener("click",(()=>{i.postMessage({command:"addNewSprite"})})),e.appendChild(u),console.log(`[Renderer] >>> redrawSpriteGrid END (Mode: ${r.mode})`)}function l(e,t,r,o,i){if(console.log(`[Renderer] >>> redrawDetailView START (Mode: ${r.mode}, Sprite: ${r.currentSprite})`),!e||!t||!t.sprites)return e&&(e.innerHTML="<div>Error: Sprite data unavailable.</div>"),void console.log("[Renderer] redrawDetailView END - Early exit (no container or spriteData)");const a=r.spriteBrush||{width:1,height:1},s=r.currentSprite,l=t.sprites[s];if(!l)return e&&(e.innerHTML=`<div>Error: Top-left sprite for brush (index: ${s}) not found.</div>`),void console.log("[Renderer] redrawDetailView END - Early exit (top-left sprite not found)");const d=l.width,c=l.height,p=a.width,u=a.height,g=d*p,m=c*u;e.innerHTML="",e.style.gridTemplateColumns=`repeat(${g}, 1fr)`;const v=[];for(let e=0;e<m;e++){const i=Math.floor(e/c),l=e%c;for(let e=0;e<a.width;e++){const p=s+e+i*a.width,u=p>=0&&p<t.count?t.sprites[p]:null,g=u&&u.pixels&&u.width===d&&u.height===c;for(let e=0;e<d;e++)if(g){const t=l*d+e,i=u.pixels[t],a=n(i,o,r);v.push({raw:i,displayHex:o[a]?.hex||"#FF00FF",spriteIndex:p,localPixelIndex:t})}else v.push({raw:0,displayHex:"rgba(0,0,0,0.1)",spriteIndex:-1,localPixelIndex:-1})}}v.forEach(((t,r)=>{const o=document.createElement("div");o.className="detail-pixel",o.style.backgroundColor=t.displayHex,o.dataset.originalSpriteIndex=t.spriteIndex,o.dataset.localPixelIndex=t.localPixelIndex,o.dataset.compositePixelIndex=r.toString(),o.draggable=!1,e.appendChild(o)}));const y=document.querySelector(".detail-info");if(y){let e="Default";if(!i){const t=document.getElementById("paletteStatus");e=t&&t.textContent&&t.textContent.includes("Palette:")&&t.textContent.replace("Palette: ","").trim()||"Custom"}let t=`Size: ${g}x${m} pixels (${p}x${u} sprites) | Palette: ${e}`;"sprite4"!==r.mode&&"tile8x8"!==r.mode||(t+=` | Offset: ${r.paletteOffset}`),y.textContent=t}const w=document.querySelector(".footer");w&&(w.textContent=`ZX Next Sprite format: ${t.count} sprites loaded. Brush: ${a.width}x${a.height}.`);const f=document.querySelector(".sprite-detail-container h2");f&&(f.innerHTML=`Sprite Brush Detail (Top-Left: ${s}, Size: ${a.width}x${a.height})`),"function"==typeof window.updateDetailPixelSizeCss&&window.updateDetailPixelSizeCss(),console.log(`[Renderer] >>> redrawDetailView END (Mode: ${r.mode}, Sprite: ${r.currentSprite}, Brush: ${a.width}x${a.height})`)}function d(e,t,r,o,i,a,s){const l=a,d=e?.querySelectorAll(".sprite-box");if(d?.forEach((e=>{const t=parseInt(e.dataset.index,10);if(!isNaN(t)&&r?.sprites&&t<r.sprites.length){const a=r.sprites[t];e.querySelectorAll(".sprite-pixel").forEach(((e,t)=>{n(a.pixels[t],i,o)===l&&(e.style.backgroundColor=s)}))}})),t&&r?.sprites&&o.currentSprite<r.sprites.length){const e=r.sprites[o.currentSprite];t.querySelectorAll(".detail-pixel").forEach(((t,r)=>{n(e.pixels[r],i,o)===l&&(t.style.backgroundColor=s)}))}}console.log("[Webview Handlers] eventHandlers.js script started");let c={isDrawing:!1,lastDrawnPixelIndex:-1,draggedIndex:-1,draggedSpriteIndex:-1,drawButton:0,editTimeout:null,isCopyingColor:!1,colorCopySourceIndex:-1,colorUpdateTimeout:null,lastMessageTime:0,isSwappingColor:!1,currentlyHoverHighlightedIndex:-1,isFillModeActive:!1,ctrlDragActive:!1,ctrlDragSourceIndex:-1,ctrlDragTargetIndex:-1,dragDisabledSwatch:null,isColorReplaceActive:!1},p={},u={},g={},m=null;function v(e){const t=e.target;c.draggedIndex=parseInt(t.dataset.colorIndex,10),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",c.draggedIndex.toString()),t.classList.add("dragging"),c.isSwappingColor=e.ctrlKey}function y(e){e.preventDefault(),e.dataTransfer.dropEffect="move";const t=e.target.closest(".color-swatch");t&&parseInt(t.dataset.colorIndex,10)!==c.draggedIndex&&t.classList.add("drag-over")}function w(e){const t=e.target.closest(".color-swatch");t&&t.classList.remove("drag-over")}function f(e){e.preventDefault();const t=e.target.closest(".color-swatch"),r=c.draggedIndex;let o=-1;t&&(o=parseInt(t.dataset.colorIndex,10),t.classList.remove("drag-over"));const i=document.querySelector(".color-swatch.dragging");if(i&&i.classList.remove("dragging"),console.log(`[Webview Handlers] Drop event - source=${r}, target=${o}, swapping=${c.isSwappingColor}`),-1===o||-1===r||o===r)return console.log("[Webview Handlers] Drop cancelled: Invalid indices or dropped on self."),c.isSwappingColor=!1,void(c.draggedIndex=-1);if(g.isDefaultPaletteActive())return m.postMessage({command:"promptEditDefaultPalette"}),c.isSwappingColor=!1,void(c.draggedIndex=-1);if(o>=256)return console.log("[Webview Handlers] Drop cancelled: Target index beyond 256-color limit."),c.isSwappingColor=!1,void(c.draggedIndex=-1);if(c.isSwappingColor){if(r<p.palette.current.length&&o<256){console.log("[Webview Handlers] Performing color and pixel swap.");const e={...p.palette.current[r]};if(o>=p.palette.current.length){for(;p.palette.current.length<=o;)p.palette.current.push({hex:"#000000",priority:!1});console.log(`[Webview Handlers] Extended palette to index ${o}`)}const t={...p.palette.current[o]};p.palette.current[r]=t,p.palette.current[o]=e;const i=g.swapPixelIndices(r,o);g.markAsDirty(!1),m.postMessage({command:"paletteSwap",indexA:r,indexB:o,newColorA:p.palette.current[r],newColorB:p.palette.current[o]}),i.forEach((e=>{p.spriteData&&p.spriteData.sprites&&p.spriteData.sprites[e]&&m.postMessage({command:"updateSpritePixels",spriteIndex:e,pixels:p.spriteData.sprites[e].pixels,skipVsCodeDirtyNotification:!0})})),g.requestFullRedraw()}}else if(r<p.palette.current.length&&o<256){console.log("[Webview Handlers] Performing palette color move.");const e={...p.palette.current[r]};if(o>=p.palette.current.length){for(;p.palette.current.length<=o;)p.palette.current.push({hex:"#000000",priority:!1});console.log(`[Webview Handlers] Extended palette to index ${o}`)}p.palette.current.splice(r,1),p.palette.current.splice(o,0,e),g.markAsDirty(!0),m.postMessage({command:"updatePaletteOrder",palette:p.palette.current}),g.requestFullRedraw()}c.isSwappingColor=!1,c.draggedIndex=-1}function x(e){e.target&&e.target.classList&&e.target.classList.remove("dragging"),document.querySelectorAll(".color-swatch.drag-over").forEach((e=>e.classList.remove("drag-over"))),c.draggedIndex=-1,c.isSwappingColor=!1,console.log("[Webview Handlers] Drag ended, reset draggedIndex and isSwappingColor")}function h(){if(g.isDefaultPaletteActive())return m.postMessage({command:"promptEditDefaultPalette"}),void g.updateEditorPanel(p.selection.editorColorIndex);const e=p.selection.editorColorIndex;if(e<0)return void console.warn("[Webview Handlers] handleColorUpdate: Invalid editorActiveIndex",e);const t=parseInt(u.sliderR.value,10),r=parseInt(u.sliderG.value,10),o=parseInt(u.sliderB.value,10),i=g.rgb9ToHex(t,r,o);for(;p.palette.current.length<=e;)p.palette.current.push({hex:"#000000",priority:!1});p.palette.current[e].hex=i,g.updateColorPreviews(e,i),u.colorPickerInput&&(u.colorPickerInput.value=i),u.primaryColorHexInput&&(u.primaryColorHexInput.value=i);const n=Date.now();n-c.lastMessageTime>=100?(g.sendColorUpdateToExtension(e,i),c.lastMessageTime=n):(c.colorUpdateTimeout&&clearTimeout(c.colorUpdateTimeout),c.colorUpdateTimeout=setTimeout((()=>{g.sendColorUpdateToExtension(e,i),c.lastMessageTime=Date.now()}),100))}function S(e,t){if(!c.isDrawing&&"mousemove"===e.type)return;const r=e.target.closest(".detail-pixel");if(!r||!p.spriteData||!p.palette.current)return;const o=parseInt(r.dataset.originalSpriteIndex,10),i=parseInt(r.dataset.localPixelIndex,10);if(isNaN(o)||isNaN(i)||o<0||o>=p.spriteData.count)return void console.warn("[DrawPixel] Invalid data attributes on clicked pixel or sprite index out of bounds.",r.dataset);const n=p.spriteData.sprites[o];if(!n||i<0||i>=n.pixels.length)return void console.warn("[DrawPixel] Sprite to modify not found or local pixel index out of bounds.");let a,s=2===t?p.selection.secondaryColorIndex:p.selection.primaryColorIndex;if("sprite4"===p.viewState.mode||"tile8x8"===p.viewState.mode){const e=p.viewState.paletteOffset;if(!(s>=e&&s<e+16))return void m.postMessage({command:"showColorOutOfBankWarning",selectedColorIndex:s,paletteOffset:e,mode:p.viewState.mode});a=s-e}else a=s;if(n.pixels[i]!==a){n.pixels[i]=a;const e=g.getDisplayColorIndex(a),t=p.palette.current[e],s=t?.hex||"#FF00FF";r.style.backgroundColor=s;const l=u.spriteListContainer?.querySelector(`.sprite-box[data-index="${o}"]`),d=l?.querySelector(`.sprite-container .sprite-pixel:nth-child(${i+1})`);if(d&&(d.style.backgroundColor=s),c.editTimeout&&clearTimeout(c.editTimeout),c.editTimeout=setTimeout((()=>{m.postMessage({command:"updateSpritePixels",spriteIndex:o,pixels:n.pixels,skipVsCodeDirtyNotification:!0})}),250),!p.editor.isDirty){const e=document.getElementById("saveButton");e&&(e.disabled=!1,e.classList.add("save-button-dirty")),p.editor.isDirty=!0}}}function I(e){if(-1!==c.currentlyHoverHighlightedIndex){const e=u.palettePicker?.querySelector(`.color-swatch[data-color-index="${c.currentlyHoverHighlightedIndex}"]`);e?.classList.remove("hover-highlight"),c.currentlyHoverHighlightedIndex=-1}u.hoverPreviewBox&&(u.hoverPreviewBox.style.backgroundColor="transparent"),u.hoverRawValue&&(u.hoverRawValue.textContent="--"),u.hoverPaletteIndex&&(u.hoverPaletteIndex.textContent="--"),u.hoverHexValue&&(u.hoverHexValue.textContent="--");const t=document.getElementById("hoverByte1"),r=document.getElementById("hoverByte2");t&&(t.textContent="-"),r&&(r.textContent="-")}function C(e){const t=e.target.closest(".color-swatch");t&&t.classList.add("palette-hover")}function b(e){const t=e.target.closest(".color-swatch");t&&t.classList.remove("palette-hover")}function D(e){const t=e.target.closest(".sprite-box");t&&(c.draggedSpriteIndex=parseInt(t.dataset.index,10),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",c.draggedSpriteIndex.toString()),setTimeout((()=>{t.classList.add("dragging-sprite")}),0),console.log(`[Webview Handlers] Sprite Drag Start: index=${c.draggedSpriteIndex}`))}function E(e){e.preventDefault(),e.dataTransfer.dropEffect="move";const t=e.target.closest(".sprite-box");e.target.closest(".add-sprite-box"),document.querySelectorAll(".sprite-box.drag-over-sprite").forEach((e=>e.classList.remove("drag-over-sprite"))),t&&parseInt(t.dataset.index,10)!==c.draggedSpriteIndex&&t.classList.add("drag-over-sprite")}function B(e){const t=e.target.closest(".sprite-box");t&&t.classList.remove("drag-over-sprite"),e.target.closest(".add-sprite-box")}function P(e){e.preventDefault();const t=e.target.closest(".sprite-box"),r=c.draggedSpriteIndex;let o=-1;o=t?parseInt(t.dataset.index,10):p.spriteData.count,document.querySelectorAll(".sprite-box.drag-over-sprite").forEach((e=>e.classList.remove("drag-over-sprite")));const i=document.querySelector(".sprite-box.dragging-sprite");if(i&&i.classList.remove("dragging-sprite"),console.log(`[Webview Handlers] Sprite Drop: source=${r}, target=${o}`),-1===r||-1===o||r===o)return console.log("[Webview Handlers] Sprite drop cancelled: Invalid indices or dropped on self."),void(c.draggedSpriteIndex=-1);if(m.postMessage({command:"reorderSprites",sourceIndex:r,targetIndex:o}),!p.spriteData.sprites.find((e=>e.index===r)))return console.error("Could not find sprite to move in local state!"),void(c.draggedSpriteIndex=-1);let n=Array.from(u.spriteListContainer.querySelectorAll(".sprite-box")).map((e=>parseInt(e.dataset.index,10)));const a=n.indexOf(r);let s=n.indexOf(o);t?(t.getBoundingClientRect(),e.clientX,e.clientY,o===p.spriteData.count&&(s=n.length)):s=n.length,n.splice(a,1);const l=a<s?s-1:s;n.splice(l,0,r);const d=[...p.spriteData.sprites],v=d.find((e=>e.index===r));if(!v)return console.error("Could not find sprite object for source index:",r),void(c.draggedSpriteIndex=-1);const y=d.indexOf(v);if(!(y>-1))return console.error("Could not find sprite object to remove at original position for index:",r),void(c.draggedSpriteIndex=-1);d.splice(y,1);let w=o;y<w&&w--,d.splice(w,0,v),d.forEach(((e,t)=>{e.index=t})),p.spriteData.sprites=d,p.spriteData.count=d.length,p.viewState.currentSprite===r?p.viewState.currentSprite=d.findIndex((e=>e===v)):(p.viewState.currentSprite,d.find((e=>{}))),g.requestFullRedraw(),c.draggedSpriteIndex=-1}function L(e){const t=document.querySelector(".sprite-box.dragging-sprite");t&&t.classList.remove("dragging-sprite"),document.querySelectorAll(".sprite-box.drag-over-sprite").forEach((e=>e.classList.remove("drag-over-sprite"))),-1!==c.draggedSpriteIndex&&(console.log("[Webview Handlers] Sprite Drag End (cleanup)"),c.draggedSpriteIndex=-1)}function k(e,t,r,n){console.log("[Webview Handlers] >>> setupEventListeners START"),p=e,u=t,g=r,m=n,c={isDrawing:!1,lastDrawnPixelIndex:-1,draggedIndex:-1,drawButton:0,editTimeout:null,isCopyingColor:!1,colorCopySourceIndex:-1,colorUpdateTimeout:null,lastMessageTime:0,isSwappingColor:!1,currentlyHoverHighlightedIndex:-1,isFillModeActive:!1,ctrlDragActive:!1,ctrlDragSourceIndex:-1,ctrlDragTargetIndex:-1,dragDisabledSwatch:null,isColorReplaceActive:!1},document.addEventListener("keydown",(e=>{"Control"===e.key&&document.querySelectorAll(".color-swatch").forEach((e=>e.classList.add("ctrl-hover")))})),document.addEventListener("keyup",(e=>{"Control"===e.key&&(document.querySelectorAll(".color-swatch").forEach((e=>e.classList.remove("ctrl-hover"))),c.ctrlDragActive&&H())})),document.addEventListener("dragend",x);const a=document.getElementById("palettePicker");if(a){function V(){if(window.colorCopyState&&window.colorCopyState.isCopying){window.colorCopyState.isCopying=!1,window.colorCopyState.sourceIndex=-1,window.colorCopyState.isCopyDrag=!1,document.querySelectorAll(".color-swatch.color-pickup").forEach((e=>e.classList.remove("color-pickup"))),document.querySelectorAll(".color-swatch.copy-target").forEach((e=>e.classList.remove("copy-target")));const e=document.getElementById("color-copy-notification");e&&e.remove(),console.log("[Webview Handlers] Color copy operation canceled")}}a.addEventListener("dragover",y),a.addEventListener("dragleave",w),a.addEventListener("mouseover",C),a.addEventListener("mouseout",b),a.addEventListener("mousedown",M),a.addEventListener("mousemove",R),a.addEventListener("mouseup",A),a.addEventListener("mouseleave",(()=>{c.ctrlDragActive&&H()})),document.addEventListener("mouseup",(e=>{c.ctrlDragActive&&A()})),document.addEventListener("keyup",(e=>{"Control"===e.key&&c.ctrlDragActive&&H()})),a.addEventListener("dragstart",(e=>{if(e.ctrlKey)return e.preventDefault(),void e.stopPropagation();const t=e.target.closest(".color-swatch");if(t){const r=parseInt(t.dataset.colorIndex,10);isNaN(r)||(c.draggedIndex=r,c.isSwappingColor=e.ctrlKey,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",r.toString()),t.classList.add("dragging"),console.log(`[Webview Handlers] Drag started for color ${r}, CTRL: ${e.ctrlKey}`))}}),{capture:!0}),a.addEventListener("contextmenu",(e=>{e.preventDefault();const t=e.target.closest(".color-swatch");if(t){const r=parseInt(t.dataset.colorIndex,10);if(!isNaN(r))if(g.selectSecondaryColor(r),e.ctrlKey){window.colorCopyState||(window.colorCopyState={}),window.colorCopyState.isCopying=!0,window.colorCopyState.sourceIndex=r,window.colorCopyState.isCopyDrag=!0,t.classList.add("color-pickup");const o=document.createElement("div");o.className="color-copy-notification",o.textContent=`Color ${r} picked up - drag to copy`,o.style.position="fixed",o.style.top=`${e.clientY+20}px`,o.style.left=`${e.clientX+10}px`,o.style.backgroundColor="var(--vscode-editor-background)",o.style.color="var(--vscode-editor-foreground)",o.style.padding="5px 10px",o.style.borderRadius="3px",o.style.border="1px solid var(--vscode-widget-border)",o.style.zIndex="1000",o.style.pointerEvents="none",o.id="color-copy-notification";const i=document.getElementById("color-copy-notification");i&&i.remove(),document.body.appendChild(o),console.log(`[Webview Handlers] CTRL+Right-click on color ${r} - ready for drag copy`)}else window.colorCopyState&&(window.colorCopyState.isCopying=!1,window.colorCopyState.sourceIndex=-1,window.colorCopyState.isCopyDrag=!1),console.log(`[Webview Handlers] Right-click selected color ${r} as secondary`)}})),a.addEventListener("mousemove",(e=>{if(window.colorCopyState&&window.colorCopyState.isCopying&&window.colorCopyState.isCopyDrag&&e.ctrlKey){const t=e.target.closest(".color-swatch"),r=document.getElementById("color-copy-notification");if(r&&(r.style.top=`${e.clientY+20}px`,r.style.left=`${e.clientX+10}px`),document.querySelectorAll(".color-swatch.copy-target").forEach((e=>e.classList.remove("copy-target"))),t){t.classList.add("copy-target");const e=parseInt(t.dataset.colorIndex,10);isNaN(e)||e===window.colorCopyState.sourceIndex||r&&(r.textContent=`Copy color ${window.colorCopyState.sourceIndex} to ${e}`)}}else window.colorCopyState&&window.colorCopyState.isCopying&&!e.ctrlKey&&V()})),a.addEventListener("mouseup",(e=>{if(2===e.button&&window.colorCopyState&&window.colorCopyState.isCopying&&window.colorCopyState.isCopyDrag){const t=e.target.closest(".color-swatch");if(t){const e=window.colorCopyState.sourceIndex,r=parseInt(t.dataset.colorIndex,10);if(!isNaN(e)&&!isNaN(r)&&e!==r)if(console.log(`[Webview Handlers] CTRL+Right drag copy from ${e} to ${r}`),g.isDefaultPaletteActive())m.postMessage({command:"promptEditDefaultPalette"});else if(r>=256)console.log("[Webview Handlers] Color copy cancelled: Target index beyond 256-color limit.");else{const o=p.palette.current[e];if(o){if(r>=p.palette.current.length){for(;p.palette.current.length<=r;)p.palette.current.push({hex:"#000000",priority:!1});console.log(`[Webview Handlers] Extended palette to index ${r} for color copy`)}if(m.postMessage({command:"paletteEdit",index:r,newHexColor:o.hex,newPriority:o.priority}),p.palette.current[r]){p.palette.current[r].hex=o.hex,p.palette.current[r].priority=o.priority;const e=parseInt(o.hex.substring(1,3),16),i=parseInt(o.hex.substring(3,5),16),n=parseInt(o.hex.substring(5,7),16),a=g.hexToRgb9(o.hex),s=a.r9,l=a.g9,d=a.b9,c=(7&s)<<5|(7&l)<<2|(3&d)>>1,u=(1&d)<<7|(o.priority?128:0);t.title=`Index: ${r}\nHex: ${o.hex}\nRGB9 bytes: (${c}, ${u})\nRGB9: (${s},${l},${d})\nRGB24: (${e},${i},${n})\nPriority: ${o.priority}`}if(g.markAsDirty(!0),t.style.backgroundColor=o.hex,r>=p.palette.visibleSize){const e=Math.min(256,Math.max(p.palette.visibleSize,r+1));p.palette.visibleSize=e;const t=document.getElementById("paletteSizeSelect");if(t){let r=!1;for(let o=0;o<t.options.length;o++)if(parseInt(t.options[o].value)===e){t.selectedIndex=o,r=!0;break}if(!r&&256!==e){const r=document.createElement("option");r.value=e.toString(),r.text=`First ${e}`;let o=!1;for(let i=0;i<t.options.length;i++)if(parseInt(t.options[i].value)>e){t.add(r,t.options[i]),t.selectedIndex=i,o=!0;break}o||(t.add(r),t.selectedIndex=t.options.length-1)}}g.requestFullRedraw()}const i=document.getElementById("color-copy-notification");i&&(i.textContent=`Color copied from ${e} to ${r}`,setTimeout((()=>{i.style.opacity="0",setTimeout((()=>i.remove()),500)}),1e3))}}}V()}})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&window.colorCopyState&&window.colorCopyState.isCopying&&V()})),document.addEventListener("mouseup",(e=>{2===e.button&&window.colorCopyState&&window.colorCopyState.isCopying&&(e.target.closest("#palettePicker")||V())})),document.addEventListener("keyup",(e=>{"Control"===e.key&&window.colorCopyState&&window.colorCopyState.isCopying&&window.colorCopyState.isCopyDrag&&V()})),a.addEventListener("drop",(e=>{f(e)}))}window.addEventListener("mouseup",(e=>{2===e.button&&window.colorCopyState&&window.colorCopyState.isCopying&&(e.target.closest(".color-swatch")||(console.log("[Webview Handlers] Color copy cancelled - released outside swatch"),window.colorCopyState.isCopying=!1,window.colorCopyState.sourceIndex=-1)),c.isDrawing&&e.button===c.drawButton&&(c.isDrawing=!1)})),u.spriteListContainer?(console.log("[Webview Handlers] Attaching sprite drag/drop listeners to spriteListContainer"),u.spriteListContainer.addEventListener("dragstart",D),u.spriteListContainer.addEventListener("dragover",E),u.spriteListContainer.addEventListener("dragleave",B),u.spriteListContainer.addEventListener("drop",P),u.spriteListContainer.addEventListener("dragend",L)):console.warn("[Webview Handlers] spriteListContainer not found for sprite drag/drop listeners."),u.viewModeSelect?u.viewModeSelect.addEventListener("change",(e=>{const t=e.target.value;u.paletteOffsetInput&&(u.paletteOffsetInput.disabled=!["sprite4","tile8x8"].includes(t)),m.postMessage({command:"changeMode",mode:t})})):console.warn("[Webview Handlers] viewModeSelect not found"),u.paletteOffsetInput?u.paletteOffsetInput.addEventListener("change",(e=>{let t=parseInt(e.target.value,10);(isNaN(t)||t<0)&&(t=0),t>15&&(t=15),e.target.value=t.toString();const r=16*t;m.postMessage({command:"changePaletteOffset",offset:r})})):console.warn("[Webview Handlers] paletteOffsetInput not found"),u.scaleSlider&&u.scaleValue?(u.scaleSlider.addEventListener("input",(e=>{const t=e.target.value,r=parseInt(t,10);u.scaleValue.textContent=t+"x",document.documentElement.style.setProperty("--sprite-scale",r.toString())})),u.scaleSlider.addEventListener("change",(e=>{const t=parseInt(e.target.value,10);m.postMessage({command:"changeScale",scale:t})}))):console.warn("[Webview Handlers] scaleSlider or scaleValue not found"),u.gridCheckbox&&u.spriteListContainer&&u.gridCheckbox.addEventListener("change",(e=>{u.spriteListContainer.classList.toggle("show-sprite-borders",e.target.checked),m.postMessage({command:"toggleGrid",showGrid:e.target.checked})})),u.loadPaletteButton&&u.loadPaletteButton.addEventListener("click",(()=>{m.postMessage({command:"loadPalette"})})),u.useDefaultPaletteButton&&u.useDefaultPaletteButton.addEventListener("click",(()=>{m.postMessage({command:"useDefaultPalette"})})),u.mainSpriteDetailContainer?(u.mainSpriteDetailContainer.addEventListener("contextmenu",(e=>{e.preventDefault()})),u.mainSpriteDetailContainer.addEventListener("mousedown",(e=>{if(e.altKey){if(e.preventDefault(),!p.spriteData||!p.palette.current)return;const t=e.target.closest(".detail-pixel");if(!t)return;const r=t.dataset.originalSpriteIndex,o=t.dataset.localPixelIndex;if(void 0===r||void 0===o)return;const i=parseInt(r,10),n=parseInt(o,10);if(isNaN(i)||isNaN(n)||i<0||i>=p.spriteData.count)return;const a=p.spriteData.sprites[i];if(!a||n<0||n>=a.pixels.length)return;const s=a.pixels[n],l=g.getDisplayColorIndex(s);0===e.button?g.selectPrimaryColor(l):2===e.button&&g.selectSecondaryColor(l)}else if(c.isFillModeActive){if(e.preventDefault(),0!==e.button&&2!==e.button)return;const t=e.target.closest(".detail-pixel");if(!t)return;const r=t.dataset.originalSpriteIndex,i=t.dataset.localPixelIndex;if(void 0===r||void 0===i)return;const n=parseInt(r,10),a=parseInt(i,10);if(isNaN(n)||isNaN(a)||n<0||n>=p.spriteData.count)return;const s=p.spriteData.sprites[n];if(!s||a<0||a>=s.pixels.length)return;const l=s.width,d=a%l,c=Math.floor(a/l);let u,v=2===e.button?p.selection.secondaryColorIndex:p.selection.primaryColorIndex;if("sprite4"===p.viewState.mode||"tile8x8"===p.viewState.mode){const e=p.viewState.paletteOffset;if(!(v>=e&&v<e+16))return void m.postMessage({command:"showColorOutOfBankWarning",selectedColorIndex:v,paletteOffset:e,mode:p.viewState.mode});u=v-e}else u=v;const y=[...s.pixels];if((0,o.GT)(y,l,s.height,d,c,u)){s.pixels=y,g.markAsDirty();const e=g.getDisplayColorIndex(u),t=(p.palette.current[e],document.querySelector(`.sprite-box[data-index="${n}"]`));if(t){const e=t.querySelectorAll(".sprite-pixel");y.forEach(((t,r)=>{if(e[r]){const o=g.getDisplayColorIndex(t),i=p.palette.current[o]?.hex||"#FF00FF";e[r].style.backgroundColor=i}}))}document.querySelectorAll(`.detail-pixel[data-original-sprite-index="${n}"]`).forEach((e=>{const t=parseInt(e.dataset.localPixelIndex,10);if(!isNaN(t)&&t<y.length){const r=y[t],o=g.getDisplayColorIndex(r),i=p.palette.current[o]?.hex||"#FF00FF";e.style.backgroundColor=i}})),m.postMessage({command:"updateSpritePixels",spriteIndex:n,pixels:s.pixels,skipVsCodeDirtyNotification:!0})}}else if(c.isColorReplaceActive){if(e.preventDefault(),0!==e.button&&2!==e.button)return;const t=e.target.closest(".detail-pixel");if(!t)return;const r=t.dataset.originalSpriteIndex,o=t.dataset.localPixelIndex;if(void 0===r||void 0===o)return;const i=parseInt(r,10),n=parseInt(o,10);if(isNaN(i)||isNaN(n)||i<0||i>=p.spriteData.count)return;const a=p.spriteData.sprites[i];if(!a||n<0||n>=a.pixels.length)return;const s=a.pixels[n];let l=2===e.button?p.selection.secondaryColorIndex:p.selection.primaryColorIndex;if("sprite4"===p.viewState.mode||"tile8x8"===p.viewState.mode){const e=p.viewState.paletteOffset;if(!(l>=e&&l<e+16))return void m.postMessage({command:"showColorOutOfBankWarning",selectedColorIndex:l,paletteOffset:e,mode:p.viewState.mode});l-=e}if(s!==l){const e=function(e,t,r){if(!p.spriteData||!p.spriteData.sprites||r<0||r>=p.spriteData.sprites.length)return!1;const o=p.spriteData.sprites[r];let i=!1;for(let r=0;r<o.pixels.length;r++)o.pixels[r]===e&&(o.pixels[r]=t,i=!0);return i}(s,l,i);if(e){g.markAsDirty();const e=g.getDisplayColorIndex(l),t=(p.palette.current[e],document.querySelector(`.sprite-box[data-index="${i}"]`));if(t){const e=t.querySelectorAll(".sprite-pixel");a.pixels.forEach(((t,r)=>{if(e[r]){const o=g.getDisplayColorIndex(t),i=p.palette.current[o]?.hex||"#FF00FF";e[r].style.backgroundColor=i}}))}document.querySelectorAll(`.detail-pixel[data-original-sprite-index="${i}"]`).forEach((e=>{const t=parseInt(e.dataset.localPixelIndex,10);if(!isNaN(t)&&t<a.pixels.length){const r=a.pixels[t],o=g.getDisplayColorIndex(r),i=p.palette.current[o]?.hex||"#FF00FF";e.style.backgroundColor=i}})),m.postMessage({command:"updateSpritePixels",spriteIndex:i,pixels:a.pixels,skipVsCodeDirtyNotification:!0}),console.log(`[Webview Handlers] Color ${s} replaced with ${l} in sprite ${i}`)}}}else e.preventDefault(),(0===e.button||2===e.button)&&(c.isDrawing=!0,c.drawButton=e.button,c.lastDrawnPixelIndex=-1,S(e,c.drawButton))})),u.mainSpriteDetailContainer.addEventListener("mousemove",(e=>{const t=e.target.closest(".detail-pixel");if(t&&!c.isDrawing){const e=t.dataset.originalSpriteIndex,r=t.dataset.localPixelIndex;if(void 0!==e&&void 0!==r){const t=parseInt(e,10),o=parseInt(r,10);if(!isNaN(t)&&!isNaN(o)&&t>=0&&t<p.spriteData.count){const e=p.spriteData.sprites[t];if(e&&o>=0&&o<e.pixels.length){const t=e.pixels[o],r=g.getDisplayColorIndex(t),n=p.palette.current[r]||{hex:"#FF00FF",priority:!1},a=n.hex,s=g.hexToRgb9(a),[l,d]=(0,i.Fs)(s.r9,s.g9,s.b9,n.priority);if(u.hoverPreviewBox&&(u.hoverPreviewBox.style.backgroundColor=a),u.hoverRawValue&&(u.hoverRawValue.textContent=t.toString()),u.hoverPaletteIndex&&(u.hoverPaletteIndex.textContent=r.toString()),u.hoverHexValue&&(u.hoverHexValue.textContent=a),u.hoverByte1&&(u.hoverByte1.textContent=l.toString(2).padStart(8,"0")),u.hoverByte2&&(u.hoverByte2.textContent=d.toString(2).padStart(8,"0")),u.hoverInfoContainer&&(u.hoverInfoContainer.style.display="flex"),-1!==c.currentlyHoverHighlightedIndex){const e=u.palettePicker?.querySelector(`.color-swatch[data-color-index="${c.currentlyHoverHighlightedIndex}"]`);e?.classList.remove("hover-highlight")}if(r<p.palette.visibleSize){const e=u.palettePicker?.querySelector(`.color-swatch[data-color-index="${r}"]`);e?.classList.add("hover-highlight"),c.currentlyHoverHighlightedIndex=r}}else I()}else I()}else I()}else t||c.isDrawing||I();c.isDrawing&&(e.preventDefault(),S(e,c.drawButton))})),u.mainSpriteDetailContainer.addEventListener("mouseleave",I),u.mainSpriteDetailContainer.addEventListener("mousemove",(e=>{c.isDrawing&&(e.preventDefault(),S(e,c.drawButton))})),u.mainSpriteDetailContainer.addEventListener("mouseleave",(e=>{c.isDrawing&&(c.isDrawing=!1)})),window.addEventListener("mouseup",(e=>{c.isDrawing&&e.button===c.drawButton&&(c.isDrawing=!1),c.isCopyingColor&&2===e.button&&(e.target&&e.target instanceof Element&&e.target.closest(".color-swatch")||(c.isCopyingColor=!1,c.colorCopySourceIndex=-1))}))):console.warn("[Webview Handlers] mainSpriteDetailContainer not found"),u.saveButton&&u.saveButton.addEventListener("click",(()=>{p.editor.isDirty&&m.postMessage({command:"saveChanges"})})),u.sliderR&&u.sliderG&&u.sliderB&&[u.sliderR,u.sliderG,u.sliderB].forEach((e=>{e.addEventListener("input",(()=>{const t="value"+e.id.slice(-1),r=document.getElementById(t);r&&(r.textContent=e.value),h()}))})),u.colorPickerInput&&u.sliderR&&u.sliderG&&u.sliderB&&u.colorPickerInput.addEventListener("input",(e=>{if(g.isDefaultPaletteActive()){m.postMessage({command:"promptEditDefaultPalette"});const t=p.selection.editorColorIndex;return void(-1!==t&&(e.target.value=p.palette.current[t]))}if(p.selection.editorColorIndex!==p.selection.primaryColorIndex)return void(e.target.value=p.palette.current[p.selection.primaryColorIndex]);const t=e.target.value,r=g.hexToRgb9(t),o=g.rgb9ToHex(r.r9,r.g9,r.b9);u.sliderR.value=r.r9.toString(),u.sliderG.value=r.g9.toString(),u.sliderB.value=r.b9.toString(),u.valueR.textContent=r.r9.toString(),u.valueG.textContent=r.g9.toString(),u.valueB.textContent=r.b9.toString(),t!==o&&(e.target.value=o),h()}));const d=document.getElementById("savePaletteButton");d&&d.addEventListener("click",(()=>{g.isDefaultPaletteActive()?m.postMessage({command:"promptEditDefaultPalette"}):(m.postMessage({command:"savePalette"}),p.palette.isDirty=!1,d.classList.remove("save-button-dirty"))})),u.reloadDataButton&&u.reloadDataButton.addEventListener("click",(()=>{const e=u.reloadDataButton;if(e.disabled)return;const t=e.textContent;e.textContent="Reloading...",e.disabled=!0,m.postMessage({command:"reloadData"}),setTimeout((()=>{e.textContent=t,e.disabled=!1}),5e3)})),u.paletteSizeSelect?u.paletteSizeSelect.addEventListener("change",(e=>{const t=parseInt(e.target.value,10);isNaN(t)||(p.palette.visibleSize=t,g.requestPaletteRedraw())})):console.warn("[Webview Handlers] paletteSizeSelect not found"),u.mergePaletteButton?u.mergePaletteButton.addEventListener("click",(()=>{g.isDefaultPaletteActive()?m.postMessage({command:"promptEditDefaultPalette"}):m.postMessage({command:"requestPaletteMerge",visiblePaletteSize:p.palette.visibleSize,startIndex:p.selection.primaryColorIndex})})):console.warn("[Webview Handlers] mergePaletteButton not found.");const k=document.getElementById("transformControls");k?k.querySelectorAll("button").forEach((e=>{const t=e.dataset.action;t?e.addEventListener("click",(()=>function(e){if(!p.spriteData||!p.viewState||p.viewState.currentSprite>=p.spriteData.sprites.length)return;const t=p.viewState.spriteBrush||{width:1,height:1},r=p.viewState.currentSprite,i=p.spriteData.sprites[r];if(!i)return;const n=i.width,a=i.height;console.log(`[Webview Handlers] Applying transform: ${e} to brush starting at sprite ${r}, brush size ${t.width}x${t.height}`);const s=[];let l=!1;if("fill"===e){c.isFillModeActive=!c.isFillModeActive;const e=document.querySelector('#transformControls button[data-action="fill"]');return e&&(e.classList.toggle("active",c.isFillModeActive),e.setAttribute("aria-pressed",c.isFillModeActive.toString())),u.mainSpriteDetailContainer&&(c.isFillModeActive?(u.mainSpriteDetailContainer.classList.add("fill-mode"),u.mainSpriteDetailContainer.style.cursor="crosshair"):(u.mainSpriteDetailContainer.classList.remove("fill-mode"),u.mainSpriteDetailContainer.style.cursor="")),c.isFillModeActive&&(c.isDrawing=!1),void console.log("[Webview Handlers] Fill mode "+(c.isFillModeActive?"activated":"deactivated"))}if(["flipH","flipV","scrollL","scrollR","scrollU","scrollD","rotateLeft","rotateRight"].includes(e)){if(["flipH","flipV","scrollL","scrollR","scrollU","scrollD","rotateLeft","rotateRight"].includes(e)){const i=t.width*n,d=t.height*a,c=new Array(i*d);for(let e=0;e<t.height;e++)for(let o=0;o<t.width;o++){const s=r+e*t.width+o;if(s>=0&&s<p.spriteData.count){const t=p.spriteData.sprites[s];if(t&&t.pixels&&Array.isArray(t.pixels))for(let r=0;r<a;r++)for(let s=0;s<n;s++){const l=r*n+s;c[(e*a+r)*i+(o*n+s)]=t.pixels[l]}}}let u;try{switch(e){case"flipH":u=(0,o.ge)(c,i,d);break;case"flipV":u=(0,o.oj)(c,i,d);break;case"scrollL":u=(0,o.Si)(c,i,d,-1);break;case"scrollR":u=(0,o.Si)(c,i,d,1);break;case"scrollU":u=(0,o.ih)(c,i,d,-1);break;case"scrollD":u=(0,o.ih)(c,i,d,1);break;case"rotateLeft":if(i!==d)return void m.postMessage({command:"showInfoMessage",message:"Rotation can only be applied to square brush areas."});u=(0,o.cV)(c,i,d).newPixels;break;case"rotateRight":if(i!==d)return void m.postMessage({command:"showInfoMessage",message:"Rotation can only be applied to square brush areas."});u=(0,o.gH)(c,i,d).newPixels}}catch(t){return void console.error(`[Webview Handlers] Error applying brush-wide transform ${e}:`,t)}for(let e=0;e<t.height;e++)for(let o=0;o<t.width;o++){const d=r+e*t.width+o;if(d>=0&&d<p.spriteData.count){const t=new Array(n*a);for(let r=0;r<a;r++)for(let s=0;s<n;s++){const l=(e*a+r)*i+(o*n+s);t[r*n+s]=u[l]}s.push({index:d,pixels:t,width:n,height:a}),l=!0}}}}else for(let i=0;i<t.height;i++)for(let d=0;d<t.width;d++){const c=r+i*t.width+d;if(c>=0&&c<p.spriteData.count){const t=p.spriteData.sprites[c];if(!t||!t.pixels||!Array.isArray(t.pixels))continue;if(t.width!==n||t.height!==a)continue;let r=null;try{switch(e){case"clear":{let e=0;const o=p.selection.primaryColorIndex;if("sprite4"===p.viewState.mode||"tile8x8"===p.viewState.mode){const t=p.viewState.paletteOffset;o>=t&&o<t+16?e=o-t:(0===i&&0===d&&m.postMessage({command:"showColorOutOfBankWarning",selectedColorIndex:o,paletteOffset:t,mode:p.viewState.mode}),e=0)}else e=o;r=new Array(t.width*t.height).fill(e)}break;case"rotateLeft":t.width===t.height?r=(0,o.cV)(t.pixels,t.width,t.height).newPixels:0===i&&0===d&&m.postMessage({command:"showInfoMessage",message:"Rotation can only be applied to square sprites."});break;case"rotateRight":t.width===t.height?r=(0,o.gH)(t.pixels,t.width,t.height).newPixels:0===i&&0===d&&m.postMessage({command:"showInfoMessage",message:"Rotation can only be applied to square sprites."});break;default:console.warn("[Webview Handlers] Unknown transform action:",e)}r&&Array.isArray(r)&&(s.push({index:c,pixels:r,width:t.width,height:t.height}),l=!0)}catch(t){console.error(`[Webview Handlers] Error applying transform ${e} to sprite ${c}:`,t),0===i&&0===d&&m.postMessage({command:"showInfoMessage",message:`Failed to apply ${e}: ${t.message}`})}}}l&&(s.forEach((e=>{const t=p.spriteData.sprites[e.index];t.pixels=e.pixels,t.width=e.width,t.height=e.height,m.postMessage({command:"updateSpritePixels",spriteIndex:e.index,pixels:t.pixels,skipVsCodeDirtyNotification:!0})})),g.markAsDirty(),g.requestFullRedraw())}(t))):console.warn(`[Webview Handlers] Button missing data-action attribute: ${e.outerHTML}`)})):console.warn("[Webview Handlers] Could not find #transformControls to attach listeners."),u.palettePicker?u.palettePicker.querySelectorAll(".color-swatch").forEach((e=>{e.addEventListener("dragstart",v),e.addEventListener("dragover",y),e.addEventListener("dragleave",w),e.addEventListener("drop",f),e.addEventListener("dragend",x)})):console.warn("[Webview Handlers] palettePicker not found for attaching swatch listeners."),document.addEventListener("keydown",(e=>{console.log(`[Webview] Key pressed: ${e.key}`),function(e,t,r,o,i){if(!t.spriteData||!t.viewState)return;const n=t.viewState.currentSprite,a=t.spriteData.count;let d=n;if("ArrowLeft"===e.key)d=Math.max(0,n-1);else if("ArrowRight"===e.key)d=Math.min(a-1,n+1);else if("ArrowUp"===e.key)d=Math.max(0,n-16);else if("ArrowDown"===e.key)d=Math.min(a-1,n+16);else{if("f"===e.key.toLowerCase()){const t=r.transformControls?.querySelector('button[data-action="fill"]');return t&&t.click(),void e.preventDefault()}if("c"===e.key.toLowerCase())return c.isColorReplaceActive||(c.isColorReplaceActive=!0,console.log("[Webview Handlers] Color replace mode activated"),r.mainSpriteDetailContainer&&(r.mainSpriteDetailContainer.classList.add("color-replace-mode"),r.mainSpriteDetailContainer.style.cursor="crosshair")),void e.preventDefault();if("p"===e.key.toLowerCase())return r.primaryPriorityFlag&&r.primaryPriorityFlag.click(),void e.preventDefault();if("r"===e.key.toLowerCase())return i.postMessage({command:"analyzeDuplicates"}),void e.preventDefault()}if(d!==n){t.viewState.currentSprite=d;const n=r.spriteListContainer;n&&t.spriteData&&t.palette&&s(n,t.spriteData,t.viewState,t.palette.current,i,t);const a=r.mainSpriteDetailContainer;a&&t.spriteData&&t.palette&&l(a,t.spriteData,t.viewState,t.palette.current,!o.isDefaultPaletteActive()),i.postMessage({command:"viewSprite",index:d}),e.preventDefault()}else if("+"===e.key){const t=document.querySelector(".add-sprite-box");t&&t.click(),e.preventDefault()}else e.ctrlKey&&e.shiftKey&&"Delete"===e.key&&(t.spriteData&&"number"==typeof t.viewState.currentSprite&&i.postMessage({command:"removeSprite",index:t.viewState.currentSprite}),e.preventDefault())}(e,p,u,g,m)})),document.addEventListener("keyup",(e=>{"c"!==e.key&&"C"!==e.key||c.isColorReplaceActive&&(c.isColorReplaceActive=!1,console.log("[Webview Handlers] Color replace mode deactivated"),u.mainSpriteDetailContainer&&(u.mainSpriteDetailContainer.classList.remove("color-replace-mode"),u.mainSpriteDetailContainer.style.cursor=""))}));const W=document.getElementById("paletteSizeSlider"),T=document.getElementById("paletteSizeValue");W&&T&&W.addEventListener("input",(e=>{const t=parseInt(e.target.value,10);T.textContent=t,p.palette.visibleSize=t,g.requestFullRedraw()}));const q=document.getElementById("mergePaletteButton");q&&q.addEventListener("click",(()=>{g.isDefaultPaletteActive()?m.postMessage({command:"promptEditDefaultPalette"}):m.postMessage({command:"mergePalette",targetOffset:0,paletteSize:p.palette.visibleSize})}));const N=document.getElementById("primaryPriorityFlag");N?N.addEventListener("change",$):console.warn("[Webview Handlers] Primary priority checkbox (#primaryPriorityFlag) not found."),p.viewState.showGrid&&u.spriteListContainer&&u.spriteListContainer.classList.add("show-sprite-borders");const F=document.getElementById("analyzeDuplicatesButton");return F&&F.addEventListener("click",(()=>{n.postMessage({command:"analyzeDuplicates"})})),console.log("[Webview Handlers] >>> setupEventListeners END"),u.spriteBrushSelect?(console.log("[Webview Handlers] Attaching listener to spriteBrushSelect"),u.spriteBrushSelect.addEventListener("change",(e=>{const t=e.target.value,r=t.split("x");if(2===r.length){const e=parseInt(r[0],10),o=parseInt(r[1],10);if(isNaN(e)||isNaN(o))console.warn("[Webview Handlers] Invalid sprite brush value parsed:",t);else{const t={width:e,height:o};console.log(`[Webview Handlers] Sprite brush changed to: ${t.width}x${t.height}`),p.viewState&&(p.viewState.spriteBrush=t),m.postMessage({command:"changeSpriteBrush",brush:t})}}else console.warn("[Webview Handlers] Invalid sprite brush value format:",t)}))):console.warn("[Webview Handlers] spriteBrushSelect DOM element not found."),{domElements:u,utils:g,vscode:m}}function $(e){if(e.target._isBeingUpdatedProgrammatically)return void console.log("[handlePriorityChange] Ignoring event triggered by programmatic update");const t=e.target.checked,r=p.selection.primaryColorIndex;if(console.log(`[handlePriorityChange] Priority checkbox changed for index ${r} to ${t}`),g.isDefaultPaletteActive())return m.postMessage({command:"promptEditDefaultPalette"}),void(e.target.checked=!t);if(r>=0&&r<p.palette.current.length){const e=p.palette.current[r];if(e){console.log(`[handlePriorityChange] Before: priority=${e.priority}`),e.priority=t,console.log(`[handlePriorityChange] After: priority=${e.priority}`),g.markAsDirty(!0);const o={command:"paletteEdit",index:r,newHexColor:e.hex,priority:t};console.log("[handlePriorityChange] Sending paletteEdit message:",o),m.postMessage(o);const i=u.palettePicker?.querySelectorAll(".color-swatch");let n=null;if(i&&(console.log(`[Priority Change] Looking for swatch with index ${r} among ${i.length} swatches`),i.forEach((e=>{parseInt(e.dataset.colorIndex,10)===r&&(n=e,console.log(`[Priority Change] Found matching swatch for index ${r}`))}))),n){console.log(`[Priority Change] Updating tooltip for index ${r}, priority: ${t}`);const o=parseInt(e.hex.substring(1,3),16),i=parseInt(e.hex.substring(3,5),16),a=parseInt(e.hex.substring(5,7),16),s=g.hexToRgb9(e.hex),l=s.r9,d=s.g9,c=s.b9,p=(7&l)<<5|(7&d)<<2|(3&c)>>1,u=(1&c)<<7|(t?128:0);n.title=`Index: ${r}\nHex: ${e.hex}\nRGB9 bytes: (${p}, ${u})\nRGB9: (${l},${d},${c})\nRGB24: (${o},${i},${a})\nPriority: ${t}`}}else console.warn(`[Webview Handlers] Could not find palette entry for index ${r} to update priority.`)}else console.warn(`[Webview Handlers] Invalid primary color index (${r}) for priority change.`)}function M(e){if(0!==e.button||!e.ctrlKey)return;const t=e.target.closest(".color-swatch");if(!t)return;const r=parseInt(t.dataset.colorIndex,10);if(isNaN(r))return;c.ctrlDragActive=!0,c.ctrlDragSourceIndex=r,t.classList.add("ctrl-dragging");const o=document.createElement("div");o.className="color-swap-notification",o.textContent=`Swap color ${r} with...`,o.style.position="fixed",o.style.top=`${e.clientY+20}px`,o.style.left=`${e.clientX+10}px`,o.style.backgroundColor="var(--vscode-editor-background)",o.style.color="var(--vscode-editor-foreground)",o.style.padding="5px 10px",o.style.borderRadius="3px",o.style.border="1px solid var(--vscode-widget-border)",o.style.zIndex="1000",o.style.pointerEvents="none",o.id="color-swap-notification";const i=document.getElementById("color-swap-notification");i&&i.remove(),document.body.appendChild(o),console.log(`[Webview Handlers] Ctrl+LMB drag started for color ${r}`),e.preventDefault(),e.stopPropagation(),t.draggable&&(t.draggable=!1,c.dragDisabledSwatch=t)}function R(e){if(!c.ctrlDragActive)return;if(!e.ctrlKey)return void H();const t=e.target.closest(".color-swatch"),r=document.getElementById("color-swap-notification");if(r&&(r.style.top=`${e.clientY+20}px`,r.style.left=`${e.clientX+10}px`),document.querySelectorAll(".color-swatch.swap-target").forEach((e=>e.classList.remove("swap-target"))),t){const e=parseInt(t.dataset.colorIndex,10);isNaN(e)||e===c.ctrlDragSourceIndex?c.ctrlDragTargetIndex=-1:(t.classList.add("swap-target"),c.ctrlDragTargetIndex=e,r&&(r.textContent=`Swap color ${c.ctrlDragSourceIndex} with ${e}`))}else c.ctrlDragTargetIndex=-1}function A(e){if(!c.ctrlDragActive)return;const t=c.ctrlDragSourceIndex,r=c.ctrlDragTargetIndex;if(-1!==t&&-1!==r&&t!==r)if(console.log(`[Webview Handlers] Ctrl+LMB drag complete - swapping colors ${t} and ${r}`),g.isDefaultPaletteActive())m.postMessage({command:"promptEditDefaultPalette"});else{const e={...p.palette.current[t]};if(r>=p.palette.current.length){for(;p.palette.current.length<=r;)p.palette.current.push({hex:"#000000",priority:!1});console.log(`[Webview Handlers] Extended palette to index ${r}`)}const o={...p.palette.current[r]};p.palette.current[t]=o,p.palette.current[r]=e;const i=g.swapPixelIndices(t,r);g.markAsDirty(!1),m.postMessage({command:"paletteSwap",indexA:t,indexB:r,newColorA:p.palette.current[t],newColorB:p.palette.current[r]}),i.forEach((e=>{p.spriteData&&p.spriteData.sprites&&p.spriteData.sprites[e]&&m.postMessage({command:"updateSpritePixels",spriteIndex:e,pixels:p.spriteData.sprites[e].pixels,skipVsCodeDirtyNotification:!0})})),g.requestFullRedraw()}H()}function H(){if(c.ctrlDragActive){document.querySelectorAll(".color-swatch.ctrl-dragging").forEach((e=>e.classList.remove("ctrl-dragging"))),document.querySelectorAll(".color-swatch.swap-target").forEach((e=>e.classList.remove("swap-target")));const e=document.getElementById("color-swap-notification");e&&e.remove(),c.dragDisabledSwatch&&(c.dragDisabledSwatch.draggable=!0,c.dragDisabledSwatch=null),c.ctrlDragActive=!1,c.ctrlDragSourceIndex=-1,c.ctrlDragTargetIndex=-1,console.log("[Webview Handlers] Ctrl+LMB drag operation canceled/completed")}}let W={spriteData:null,viewState:null,palette:{current:[],isCustom:!1,default:[],visibleSize:256,isDirty:!1},selection:{primaryColorIndex:0,secondaryColorIndex:0,editorColorIndex:-1},editor:{isDirty:!1}};!function(){const e=acquireVsCodeApi();function t(){return!W.palette.isCustom}function r(){console.log("[Webview Redraw] >>> requestFullRedraw START");const r=document.getElementById("palettePicker"),o=document.querySelector(".sprites-grid"),i=document.querySelector(".detail-container");a(r,W.palette,W.selection,t(),y,w),console.log("[Webview Redraw] --- requestFullRedraw: Populated Palette Picker"),s(o,W.spriteData,W.viewState,W.palette.current,e,W),console.log("[Webview Redraw] --- requestFullRedraw: Redrew Sprite Grid"),l(i,W.spriteData,W.viewState,W.palette.current,t()),console.log("[Webview Redraw] --- requestFullRedraw: Redrew Detail View"),m(),w(W.selection.secondaryColorIndex);const n=document.getElementById("mainContentContainer");n&&"hidden"===n.style.visibility&&(n.style.visibility="visible",console.log("[Webview Redraw] --- Made mainContentContainer visible.")),console.log("[Webview Redraw] >>> requestFullRedraw END")}function o(){a(document.getElementById("palettePicker"),W.palette,W.selection,t(),y,w),m(),w(W.selection.secondaryColorIndex)}function n(t,r,o=!1){o||v(!0);const i=W.palette.current[t],n={command:"paletteEdit",index:t,newHexColor:i?.hex,priority:i?.priority,skipDirtyNotification:o};e.postMessage(n)}function c(e,t){const r=document.getElementById("palettePicker"),o=document.querySelector(".sprites-grid"),i=document.querySelector(".detail-container"),n=document.getElementById("primaryPreviewBox"),a=document.getElementById("primaryHexValue"),s=document.getElementById("secondaryPreviewBox"),l=document.getElementById("secondaryHexValue"),c=r?.querySelector(`.color-swatch[data-color-index="${e}"]`);c&&(c.style.backgroundColor=t),e===W.selection.primaryColorIndex&&(n&&(n.style.backgroundColor=t),a&&(a.textContent=t)),e===W.selection.secondaryColorIndex&&(s&&(s.style.backgroundColor=t),l&&(l.textContent=t)),d(o,i,W.spriteData,W.viewState,W.palette.current,e,t)}function p(e,t){if(!W.spriteData||!W.spriteData.sprites)return[];const r=[];return W.spriteData.sprites.forEach(((o,i)=>{let n=!1;const a=o.pixels.map((r=>r===e?(n=!0,t):r===t?(n=!0,e):r));n&&(o.pixels=a,r.push(i))})),r}function u(e){const t=document.getElementById("sliderR"),r=document.getElementById("sliderG"),o=document.getElementById("sliderB"),n=document.getElementById("valueR"),a=document.getElementById("valueG"),s=document.getElementById("valueB"),l=document.getElementById("primaryColorHex"),d=document.getElementById("colorPickerInput"),c=document.getElementById("primaryPriorityFlag");if(e<0||e>=W.palette.current.length)return void(W.selection.editorColorIndex=-1);W.selection.editorColorIndex=e;const p=W.palette.current[e],u=p.hex,g=(0,i.jD)(u);t&&(t.value=g.r9.toString()),r&&(r.value=g.g9.toString()),o&&(o.value=g.b9.toString()),n&&(n.textContent=g.r9.toString()),a&&(a.textContent=g.g9.toString()),s&&(s.textContent=g.b9.toString()),d&&(d.value=u),l&&(l.value=u),c&&(c.checked=p.priority)}function g(e){if(!W.viewState||!W.palette.current)return 0;const t=W.viewState.mode,r=W.viewState.paletteOffset;let o=e;return"sprite4"!==t&&"tile8x8"!==t||(o=r+e),o<0||o>=W.palette.current.length?(console.warn(`Calculated display index ${o} out of bounds for palette length ${W.palette.current.length}. Raw: ${e}, Offset: ${r}`),0):o}function m(){const e=W.selection.primaryColorIndex;if(e<0||e>=W.palette.current.length)return;const t=W.palette.current[e],r=t.hex,o=document.getElementById("primaryPreviewBox"),n=document.getElementById("primaryHexValue"),a=document.getElementById("primaryR9Value"),s=document.getElementById("primaryG9Value"),l=document.getElementById("primaryB9Value"),d=document.getElementById("primaryPriorityFlag");o&&(o.style.backgroundColor=r),n&&(n.textContent=r),u(e);const c=(0,i.jD)(r);a&&(a.textContent=c.r9.toString()),s&&(s.textContent=c.g9.toString()),l&&(l.textContent=c.b9.toString()),d&&(console.log(`[refreshPrimaryColorDisplay] Updating priority checkbox for index ${e} to ${t.priority}`),d._isBeingUpdatedProgrammatically=!0,d.checked=t.priority,setTimeout((()=>{d&&(d._isBeingUpdatedProgrammatically=!1)}),0))}function v(e=!1){if(e){if(!W.palette.isDirty){W.palette.isDirty=!0;const e=document.getElementById("savePaletteButton");e&&e.classList.add("save-button-dirty")}}else if(!W.editor.isDirty){const e=document.getElementById("saveButton");e&&(e.disabled=!1,e.classList.add("save-button-dirty")),W.editor.isDirty=!0}}function y(e){if(null==e||e<0||e>=W.palette.current.length)return void console.warn(`[Webview] Invalid primary color index: ${e}`);if(e===W.selection.primaryColorIndex)return;W.selection.primaryColorIndex=e;const t=W.palette.current[e],r=t.hex,o=document.getElementById("primaryPreviewBox"),n=document.getElementById("primaryColorIndex"),a=document.getElementById("primaryHexValue"),s=document.getElementById("palettePicker"),l=document.getElementById("primaryR9Value"),d=document.getElementById("primaryG9Value"),c=document.getElementById("primaryB9Value"),p=document.getElementById("primaryPriorityFlag");if(o&&(o.style.backgroundColor=r),n&&(n.textContent=e),a&&(a.textContent=r),u(e),s){s.querySelectorAll(".color-swatch.primary-selected").forEach((e=>e.classList.remove("primary-selected")));const t=s.querySelector(`.color-swatch[data-color-index="${e}"]`);t&&t.classList.add("primary-selected")}const g=(0,i.jD)(r);l&&(l.textContent=g.r9.toString()),d&&(d.textContent=g.g9.toString()),c&&(c.textContent=g.b9.toString()),p&&(p._isBeingUpdatedProgrammatically=!0,p.checked=t.priority,setTimeout((()=>{p&&(p._isBeingUpdatedProgrammatically=!1)}),0))}function w(e){if(null==e||e<0||e>=W.palette.current.length)return void console.warn(`[Webview] Invalid secondary color index: ${e}`);if(e===W.selection.secondaryColorIndex)return;W.selection.secondaryColorIndex=e;const t=W.palette.current[e],r=t?t.hex:"#000000",o=document.getElementById("secondaryColorIndex"),i=document.getElementById("secondaryPreviewBox"),n=document.getElementById("secondaryHexValue"),a=document.getElementById("palettePicker");if(o&&(o.textContent=e.toString()),i&&(i.style.backgroundColor=r),n&&(n.textContent=r),a){a.querySelectorAll(".color-swatch.secondary-selected").forEach((e=>e.classList.remove("secondary-selected")));const t=a.querySelector(`.color-swatch[data-color-index="${e}"]`);t&&t.classList.add("secondary-selected")}}function f(){if(W.viewState&&W.viewState.spriteBrush&&W.spriteData&&W.spriteData.sprites&&W.spriteData.sprites.length>0){const e=W.spriteData.width,t=W.spriteData.height,r=W.viewState.spriteBrush.width,o=W.viewState.spriteBrush.height;let i;i=1===r&&1===o?8===e&&8===t?"30px":"18px":8===e&&8===t?"15px":"10px",document.documentElement.style.setProperty("--detail-pixel-size",i)}}window.updateDetailPixelSizeCss=f,window.addEventListener("message",(async d=>{const x=d.data;switch(x.command){case"initialize":console.log("[Webview JS] Received initialize"),x.initialState?(W.viewState=x.initialState.viewState,W.palette.current=x.initialState.palette,W.palette.isCustom=x.initialState.isCustomPaletteMode,W.palette.default=x.initialState.defaultPalette,W.editor.isDirty=x.initialState.viewState.isDirty,function(){console.log("[Webview Init] >>> initializeUI START");const d=window.initialData;if(!d)return console.error("[Webview] Initial data not found!"),void(document.body.innerHTML='<div style="color: red; padding: 20px;">Error: Failed to load initial sprite data.</div>');document.body.setAttribute("tabindex","0");const m=document.getElementById("scaleSlider"),f=document.getElementById("scaleValue"),x=document.getElementById("showGrid"),h=document.getElementById("paletteOffset"),S=document.querySelector(".sprites-grid"),I=document.querySelector(".detail-container"),C=document.getElementById("palettePicker"),b=document.getElementById("saveButton"),D=document.getElementById("viewMode"),E=document.getElementById("loadPalette"),B=document.getElementById("paletteStatus"),P=document.getElementById("useDefaultPalette"),L=document.getElementById("primaryColorIndex"),$=document.getElementById("primaryPreviewBox"),M=document.getElementById("primaryHexValue"),R=document.getElementById("secondaryColorIndex"),A=document.getElementById("secondaryPreviewBox"),H=document.getElementById("secondaryHexValue"),T=document.getElementById("colorPickerInput"),q=document.getElementById("reloadDataButton"),N=document.getElementById("sliderR"),F=document.getElementById("sliderG"),V=document.getElementById("sliderB"),O=document.getElementById("valueR"),G=document.getElementById("valueG"),z=document.getElementById("valueB"),U=document.getElementById("hoverInfoContainer"),K=document.getElementById("hoverPreviewBox"),J=document.getElementById("hoverRawValue"),j=document.getElementById("hoverPaletteIndex"),X=document.getElementById("hoverHexValue"),Y=document.getElementById("hoverByte1"),_=document.getElementById("hoverByte2"),Q=document.getElementById("paletteSizeSelect"),Z=document.getElementById("mergePaletteButton"),ee=document.getElementById("primaryR9Value"),te=document.getElementById("primaryG9Value"),re=document.getElementById("primaryB9Value"),oe=document.getElementById("primaryPriorityFlag"),ie=document.getElementById("savePaletteButton"),ne={scaleSlider:m,scaleValue:f,gridCheckbox:x,paletteOffsetInput:h,spriteListContainer:S,mainSpriteDetailContainer:I,palettePicker:C,saveButton:b,viewModeSelect:D,loadPaletteButton:E,paletteStatusSpan:B,useDefaultPaletteButton:P,primaryColorIndexSpan:L,primaryPreviewBox:$,primaryHexValueSpan:M,secondaryColorIndexSpan:R,secondaryPreviewBox:A,secondaryHexValueSpan:H,colorPickerInput:T,reloadDataButton:q,sliderR:N,sliderG:F,sliderB:V,valueR:O,valueG:G,valueB:z,hoverInfoContainer:U,hoverPreviewBox:K,hoverRawValue:J,hoverPaletteIndex:j,hoverHexValue:X,paletteSizeSelect:Q,mergePaletteButton:Z,primaryR9Value:ee,primaryG9Value:te,primaryB9Value:re,primaryPriorityFlag:oe,savePaletteButton:ie,hoverByte1:Y,hoverByte2:_,spriteBrushSelect:document.getElementById("spriteBrushSelect")};if(W.spriteData=null,W.viewState=d.viewState,W.palette.isCustom=d.isCustomPaletteMode,W.palette.current=d.palette,W.palette.default=d.defaultPalette,W.selection.primaryColorIndex=0,W.selection.secondaryColorIndex=0,W.editor.isDirty=d.viewState?.isDirty??!1,console.log(`[Webview Init] Initialized appState.palette.current. isCustom: ${W.palette.isCustom}. First 5 entries: ${JSON.stringify(W.palette.current?.slice(0,5))}`),console.log(`[Webview Init] Stored appState.palette.default. First 5 entries: ${JSON.stringify(W.palette.default?.slice(0,5))}`),console.log("[Webview Init] Updating UI elements from initial state..."),m&&(m.value=W.viewState.scale.toString()),f&&(f.textContent=W.viewState.scale+"x"),x&&(x.checked=W.viewState.showGrid),h){const e=Math.floor(W.viewState.paletteOffset/16);h.value=e.toString(),h.disabled=!["sprite4","tile8x8"].includes(W.viewState.mode)}if(D&&(D.value=W.viewState.mode),B){const e=d.paletteName;B.textContent=W.palette.isCustom?`Palette: ${e}`:"Default palette",B.title=W.palette.isCustom?e:""}b&&(b.disabled=!W.editor.isDirty,b.classList.toggle("save-button-dirty",W.editor.isDirty)),ie&&(ie.disabled=!W.palette.isCustom,ie.classList.toggle("save-button-dirty",W.palette.isDirty)),Q&&(Q.value=W.palette.visibleSize.toString());const ae={isDefaultPaletteActive:t,requestFullRedraw:r,requestPaletteRedraw:o,sendColorUpdateToExtension:n,updateColorPreviews:c,swapPixelIndices:p,updateEditorPanel:u,getDisplayColorIndex:g,markAsDirty:v,selectPrimaryColor:y,selectSecondaryColor:w,hexToRgb9:i.jD,rgb9ToHex:i.nQ,rgbStringToHex:i.dK};console.log("[Webview Init] Rendering palette picker..."),a(C,W.palette,W.selection,t(),y,w),console.log(`[Webview JS - initializeUI] After populatePalettePicker, #palettePicker has ${C?.childElementCount||0} children.`),console.log("[Webview Init] Rendering sprite grid..."),s(S,W.spriteData,W.viewState,W.palette.current,e,W),console.log("[Webview Init] Rendering detail view..."),l(I,W.spriteData,W.viewState,W.palette.current,t()),console.log("[Webview Init] Selecting initial colors..."),y(0),w(1),b&&(b.disabled=!W.editor.isDirty,b.classList.toggle("save-button-dirty",W.editor.isDirty)),console.log("[Webview Init] Requesting full sprite data..."),e.postMessage({command:"requestFullSpriteData"}),console.log("[Webview Init] Calling setupEventListeners..."),k(W,ne,ae,e),setTimeout((()=>{console.log("[Webview Init] Setting focus to make keyboard navigation work"),document.body.focus();const e=document.getElementById("mainContentContainer");e&&(e.setAttribute("tabindex","0"),e.focus());const t=document.querySelector(".detail-container");t&&t.setAttribute("tabindex","0"),console.log("[Webview Init] Keyboard handlers ready. Press arrow keys to navigate.")}),300),console.log("[Webview Init] >>> initializeUI END")}()):(console.error("[Webview JS] Received initialize message but initialState is missing!"),document.body.innerHTML='<div class="error-message">Error: Missing initial state from extension.</div>');break;case"fullSpriteData":console.log("[Webview JS] Received fullSpriteData"),x.spriteData?(W.spriteData=x.spriteData,console.log(`[Webview JS] Stored full sprite data (${W.spriteData.count} sprites).`),W.viewState?(console.log("[Webview JS] viewState exists, triggering redraw."),f(),r()):console.warn("[Webview JS] Received fullSpriteData but viewState is still null. Redraw deferred.")):console.error("[Webview JS] Received fullSpriteData message but spriteData is missing!");break;case"getViewState":console.log("[Webview JS] Responding to getViewState request"),W.viewState&&e.postMessage({command:"viewStateResponse",viewState:{mode:W.viewState.mode,paletteOffset:W.viewState.paletteOffset,scale:W.viewState.scale,showGrid:W.viewState.showGrid,currentSprite:W.viewState.currentSprite}});break;case"viewSprite":if(window.localState&&window.localState.isFillModeActive){const e=document.querySelector('#transformControls button[data-action="fill"]');e&&("function"==typeof handleTransform?handleTransform("fill"):e.click());const t=document.querySelector(".detail-container");t&&(t.classList.remove("fill-mode"),t.style.cursor=""),window.localState&&(window.localState.isFillModeActive=!1)}break;case"update":console.log("[Webview Message] >>> Received 'update' message",x);try{let e=!1;if(x.viewState){W.viewState=x.viewState,W.editor.isDirty=x.viewState.isDirty,document.getElementById("paletteOffset")&&(document.getElementById("paletteOffset").value=Math.floor(x.viewState.paletteOffset/16),document.getElementById("paletteOffset").disabled=!["sprite4","tile8x8"].includes(x.viewState.mode)),document.getElementById("viewMode")&&(document.getElementById("viewMode").value=x.viewState.mode),document.getElementById("scaleSlider")&&(document.getElementById("scaleSlider").value=x.viewState.scale.toString()),document.getElementById("scaleValue")&&(document.getElementById("scaleValue").textContent=x.viewState.scale+"x"),document.getElementById("showGrid")&&(document.getElementById("showGrid").checked=x.viewState.showGrid);const e=document.getElementById("saveButton");e&&(e.disabled=!x.viewState.isDirty,e.classList.toggle("save-button-dirty",x.viewState.isDirty));const t=document.getElementById("spriteBrushSelect");if(t&&x.viewState.spriteBrush){const e=`${x.viewState.spriteBrush.width}x${x.viewState.spriteBrush.height}`;t.value!==e&&(t.value=e)}}if(x.spriteData){e=!0,W.spriteData=x.spriteData;const t=document.getElementById("reloadDataButton");t&&t.disabled&&(t.textContent="Reload Sprite Data",t.disabled=!1)}if(x.palette){W.palette.current=x.palette,W.palette.isCustom=!0;const e=document.getElementById("paletteStatus");e&&x.paletteName&&(e.textContent="Palette: "+x.paletteName);const t=document.getElementById("savePaletteButton");t&&(t.disabled=!1),m()}else if(x.hasOwnProperty("palette")&&null===x.palette){W.palette.current=W.palette.default||[],W.palette.isCustom=!1;const e=document.getElementById("paletteStatus");e&&(e.textContent="Default palette");const t=document.getElementById("savePaletteButton");t&&(t.disabled=!0),m()}if(f(),W.viewState&&W.spriteData&&"number"==typeof W.viewState.currentSprite&&W.viewState.currentSprite>=W.spriteData.count){W.viewState.currentSprite;const e=Math.max(0,W.spriteData.count-1);W.viewState.currentSprite=e}console.log("[Webview Message] --- Calling requestFullRedraw after 'update'"),r(),console.log("[Webview Message] --- Returned from requestFullRedraw after 'update'")}catch(e){console.error("[Webview JS] Error handling update message:",e);const t=document.createElement("div");t.className="error-message",t.textContent=`Error updating UI: ${e.message}. Try reopening the file.`,document.body.prepend(t)}break;case"changesSaved":if(console.log("[Webview JS] Changes saved"),x.isPaletteChange){W.palette.isDirty=!1;const e=document.getElementById("savePaletteButton");e&&e.classList.remove("save-button-dirty")}else{W.editor.isDirty=!1;const e=document.getElementById("saveButton");e&&(e.disabled=!0,e.classList.remove("save-button-dirty"))}break;case"spritePasted":if(void 0!==x.targetIndex&&x.pixels&&W.spriteData&&W.spriteData.sprites){const t=W.spriteData.sprites.find((e=>e.index===x.targetIndex));if(t){t.pixels=x.pixels,s(document.querySelector(".sprites-grid"),W.spriteData,W.viewState,W.palette.current,e,W),x.targetIndex===W.viewState.currentSprite&&l(document.querySelector(".detail-container"),W.spriteData,W.viewState,W.palette.current,!W.palette.isCustom),W.editor.isDirty=!0;const r=document.getElementById("saveButton");r&&(r.disabled=!1,r.classList.add("save-button-dirty"))}}break;case"markAsWebviewDirty":W.editor.isDirty=!0;const d=document.getElementById("saveButton");d&&(d.disabled=!1,d.classList.add("save-button-dirty"));break;case"dragStarted":const{index:S,isSwapping:I}=x;console.log(`[Webview JS] Drag started for color ${S}, swapping: ${I}`),"number"==typeof S&&(window.dragState={sourceIndex:S,isSwapping:!!I});break;case"spriteSelected":if(console.log(`[Webview Message] Received spriteSelected for index ${x.currentSpriteIndex}`),W.viewState){W.viewState.currentSprite=x.currentSpriteIndex,f();const t=document.querySelector(".sprites-grid");t&&W.spriteData&&s(t,W.spriteData,W.viewState,W.palette.current,e,W);const r=document.querySelector(".detail-container");r&&W.spriteData&&l(r,W.spriteData,W.viewState,W.palette.current,!W.palette.isCustom);const o=document.querySelector(".sprite-detail h2");o&&(o.textContent=`Sprite ${x.currentSpriteIndex} Detail`)}break;case"highlightDuplicates":x.duplicates&&Array.isArray(x.duplicates)?(console.log(`[Webview JS] Received ${x.duplicates.length} duplicates to highlight`),h=x.duplicates,document.querySelectorAll(".sprite-box").forEach((e=>{e.classList.remove("duplicate-exact"),e.classList.remove("duplicate-flipped"),e.classList.remove("duplicate-rotated"),e.removeAttribute("data-original"),e.removeAttribute("data-match-type")})),h.forEach((e=>{const t=document.querySelector(`.sprite-box[data-index="${e.originalIndex}"]`),r=document.querySelector(`.sprite-box[data-index="${e.duplicateIndex}"]`);if(t&&t.classList.add("original-sprite"),r){switch(e.matchType){case"exact":r.classList.add("duplicate-exact");break;case"flippedH":case"flippedV":r.classList.add("duplicate-flipped");break;case"rotated180":r.classList.add("duplicate-rotated")}r.setAttribute("data-original",e.originalIndex),r.setAttribute("data-match-type",e.matchType),r.title=`Duplicate of sprite #${e.originalIndex} (${e.matchType})`}}))):console.error("[Webview JS] Received highlightDuplicates but data is invalid");break;default:console.log("[Webview JS] Unhandled message:",x)}var h}))}()})();